/**
 ** kvm.js - 一款兼容AMD,angular模块规范同时支持依赖注入的模块管理器
 ** @author Janry
 ** @version v0.0.3
 **/
!function(global){function _type(t){return Object.prototype.toString.call(t)}function isReference(t){return isArray(t)||isObject(t)}function isValue(t){return!isReference(t)}function isEmpty(t){if(null==t)return!0;if(t.length>0)return!1;if(0===t.length)return!0;for(var e in t)if(hasOwnProperty.call(t,e))return!1;return!0}function toArray(){var t;return t=[].slice.apply(arguments),[].slice.apply(t[0],t.slice(1))}function forEach(t,e,n){var r,i,o,s;if(isFunction(e)){if(isReference(t)){for(i=Object.keys(t),o=i.length,r=0,s=[],0==o&&isFunction(n)&&n();o>r&&e(t[i[r]],i[r])!==!1;)s.push(r++);return s}isFunction(n)&&n()}}function merge(){var t,e,n,r=!1,i=!0;return t=toArray(arguments),isBoolean(t[0])&&(r=t[0],t=t.slice(1)),isFunction(t[t.length-1])&&(n=t[t.length-1],t.pop()),isBoolean(t[t.length-1])&&(i=t[t.length-1],t.pop()),e=t.length,2>e?t[0]:2===e?(forEach(t[1],function(e,o){isFunction(n)&&n(o,t[0],t[1]),void 0!==t[1][o]&&null!==t[1][o]&&(i?(t[0][o]=t[0][o]||t[1][o].constructor(),r&&isReference(e)?merge(r,t[0][o],e,i,n):t[0][o]=e):t[0][o]||(t[0][o]=t[0][o]||t[1][o].constructor(),r&&isReference(e)?merge(r,t[0][o],e,i,n):t[0][o]=e))}),t[0]):merge(r,t[0],merge.apply(null,[r].concat(t.slice(1))))}function Class(t,e){return t&&t.constructor&&isFunction(t.constructor)&&t.constructor!==Object?(_class=function(){return t.constructor.apply(this,toArray(arguments))},_class.toString=function(){return t.constructor.toString()}):_class=function(){},merge(_class.prototype,t),merge(_class,e),_class}for(var TYPES="Function,String,Array,Object,Number,Boolean".split(","),hasOwnProperty=Object.prototype.hasOwnProperty,i=0;i<TYPES.length;i++)eval("function is"+TYPES[i]+'(val){return _type(val) === "[object '+TYPES[i]+']"};');Class.inherit=function(){function t(t,e){function n(){return t.apply(this,e)}return n.prototype=t.prototype,new n}function e(){var n=t(i,toArray(arguments));return merge(this,n,!1),this.$super=e,this.$parent&&isArray(this.$parent)?this.$parent.push(n):this.$parent=[n],n}var n=toArray(arguments);if(2==n.length){var r=n[0],i=n[1];isFunction(r)&&isFunction(i)&&(merge(r.prototype,i.prototype,!1,function(t,e,n){if(n.$$isprotocol===!0&&isFunction(n[t])&&!isFunction(e[t]))throw"The subclass does not follow protocol"}),r.prototype.$super=e,r.prototype.$parent=i.prototype,r.prototype.constructor=r)}else if(n.length>2)for(var o=1;o<n.length;o++)Class.inherit(n[0],n[o])},Class.protocol=function(t){return t.$$isprotocol=!0,Class(t)};var Emitter=Class({constructor:function(t){this.__$$events__=t?t:{}},$on:function(t,e){var n=this;return t=t.split(","),forEach(t,function(t){isFunction(e)&&(n.__$$events__[t]&&isArray(n.__$$events__[t])?n.__$$events__[t].push(e):n.__$$events__[t]=[e])}),this},$emit:function(t){var e=toArray(arguments),n=0,r=this.__$$events__[t];if(r&&isArray(r))for(n;n<r.length;n++)r[n].apply(null,e.slice(1));return this},$remove:function(t,e){var n=this.__$$events__[t];if(n&&isArray(n))if(e)for(var r=n.length-1;r>=0;r--)e===n[r]&&n.splice(r,1);else delete this.__$$events__[t];return this}}),Loader=function(){var t=[],e=Class({constructor:function(e,r){var i=this,o=Injector.data("shims");i.req_list=e,i.loaders=[],i.results=[],forEach(e,function(e){var s,c,u=Injector.resolve(e);if(forEach(t,function(t){return t.uri==u?(s=t,!1):void 0}),s||(c=ModuleDB.get(e,u))||(s=new n(e,u,function(){o[e]&&Injector.define(e,o[e].factory)}),t.push(s)),s&&s.module){if(i.results.push(s.module),i._checkDone())return r(i.results),i._destroy(),!1}else if(c){if(i.results.push(c),i._checkDone())return r(i.results),i._destroy(),!1}else i.loaders.push(s),s.$on("loaded",function(t){return s.module=t,i.results.push(t),i._checkDone()?(r(i.results),i._destroy(),!1):void 0})}),forEach(i.loaders,function(t){t.load()})},_destroy:function(){delete this.results,delete this.loaders,delete this.req_list},_checkDone:function(){return this.req_list.length==this.results.length}}),n=Class({constructor:function(t,e,n){var r=this;this.id=t,this.uri=e,this.callback=n,this.state="pendding",this.module=null,this.$super(),this.$on("loaded",function(){r.state="done"})},load:function(){this._load(this.uri,this.callback)},_load:function(t,e){function n(t,e){function n(n){t.onload=t.onerror=t.onreadystatechange=null,Injector.debug||i.removeChild(t),t=null,e&&e(n)}var r="onload"in t;r?(t.onload=n,t.onerror=function(){n(!0)}):t.onreadystatechange=function(){/loaded|complete/.test(t.readyState)&&n()}}var r=document,i=r.head||r.getElementsByTagName("head")[0]||r.documentElement,o=i.getElementsByTagName("base")[0],s=r.createElement("script");s.async=!0,s.src=t,n(s,e),o?i.insertBefore(s,o):i.appendChild(s)}});return Class.inherit(n,Emitter),Class({constructor:function(t){this.module=t},setModule:function(t){this.module=t},fetchDeps:function(t){var e=[],n=this;forEach(this.module.dep_ids,function(t){n.module.injectors&&n.module.injectors[t]||e.push(t)}),Loader.fetchList(e,t)},fetch:function(t){Loader.fetchList([this.module.id],function(e){e&&e.length>0&&isFunction(t)&&t(e[0])})}},{getLoader:function(e,n,r){var n=n||Injector.resolve(e);if(!n)throw new Error("资源未标识");forEach(t,function(t){return t.uri&&t.uri==n||t.id&&t.id==e?(r(t),!1):void 0})},fetchList:function(){var t=[],n=toArray(arguments),r=n[n.length-1];isFunction(r)&&(n=n.slice(0,n.length-1),forEach(n,function(e){isArray(e)?t=t.concat(e):t.push(e)}),new e(t,r))}})}(),Module=Class({constructor:function(t){merge(this,{id:"",uri:"",dep_ids:[],factory:null,injectors:null},t),this.$super(),this.register()},register:function(){var t=this;this.$on("loaded",function(){t.loaded=!0}),this.$on("invoked",function(){t.invoked=!0})}}),ModuleDB=function(){var t=[];return Class.inherit(Module,Emitter),{add:function(e){var n=new Module(e);return this.get(e.id,e.uri)||(t.push(n),n.$emit("loaded"),Loader.getLoader(e.id,e.uri,function(t){t.$emit("loaded",n)})),this},get:function(e,n){var r;return forEach(t,function(t){return t.id&&e&&t.id==e||t.uri&&n&&t.uri==n?(r=t,!1):void 0}),r}}}(),Injector=function(){function t(){var t=document,e=t.head||t.getElementsByTagName("head")[0]||t.documentElement;if(t.currentScript)return t.currentScript.src;var n;try{a.b.c()}catch(r){n=r.stack,!n&&window.opera&&(n=(String(r).match(/of linked script \S+/g)||[]).join(" "))}if(n)return n=n.split(/[@ ]/g).pop(),n="("==n[0]?n.slice(1,-1):n,n.replace(/(:\d+)?:\d+$/i,"");for(var i,o=e.getElementsByTagName("script"),s=0;i=o[s++];)if("interactive"===i.readyState)return i.className=i.src}function e(t,e){return n(e)?e:r(e)?i(t,e)+".js":e}function n(t){return/^https?:|^file:|^\/|\.js$/.test(t)}function r(t){return 0===(t+"").indexOf(".")}function i(){var t=arguments.length;if(0===t)throw new Error("resolveUrl requires at least one argument; got none.");var e=document.createElement("base");if(e.href=arguments[0],1===t)return e.href;var n=document.getElementsByTagName("head")[0];n.insertBefore(e,n.firstChild);for(var r,i=document.createElement("a"),o=1;t>o;o++)i.href=arguments[o],r=i.href,e.href=r;return n.removeChild(e),r}function o(t){return isFunction(t)||isArray(t)&&isFunction(t[t.length-1])}function s(t){var e=!0;return isArray(t)?(forEach(t,function(t){return isString(t)?void 0:e=!1}),e):!1}function c(){var e,n=toArray(arguments),r="",i="",c=[],u=null,a=!0;return isBoolean(n[0])?(a=n[0],n=n.slice(1,4)):n=n.slice(0,3),forEach(n,function(t){o(t)?isFunction(t)?e=t:(e=t[t.length-1],c=t.slice(0,t.length-1)):s(t)?c=t:isString(t)?(r=t,i=Injector.resolve(r)):isObject(t)&&(u=t)}),!i&&a&&(i=t()),new Module({uri:i,id:r,dep_ids:c,factory:e,injectors:u})}function u(t,e,n,r){function i(n,i){var c;i&&(o[n]=i,s++),s==e.dep_ids.length&&(c=r?e.instance?e.instance:e.instance=e.factory.apply(null,o):e.factory.apply(null,o),e.$emit("invoked"),t(c))}var o=[],s=0;r=isBoolean(r)?r:!1,forEach(e.dep_ids,function(t,o){e.injectors&&e.injectors[t]?Injector.invoke(e.injectors[t]).then(function(t){i(o,t)})["catch"](function(t){throw t}):forEach(n,function(e){(e.id&&e.id==t||e.uri&&e.uri==Injector.resolve(t))&&(e.instance&&r&&i(o,e.instance),Injector.invoke(t).then(function(t){i(o,t)})["catch"](function(t){throw t}))})},function(){i()})}function l(t){if(!isString(t))throw new Error("路径类型错误");var e,n=/\{([^{}]+)\}/g;return e=t.replace(n,function(t,e){return f.vars[e]?f.vars[e]:e}),n.test(e)?tmp(e):e}var f={baseUrl:window.location.href,shims:{},vars:{},alias:{}};return{config:function(t){merge(f,t)},resolve:function(t){return t=l(f.shims[t]?f.shims[t].url||f.shims[t].uri:f.alias[t]?f.alias[t]:t),e(f.baseUrl,t)},data:function(t){return t?f[t]:f},define:function(){var t=c.apply(null,toArray(arguments));if(!t.uri||!t.factory)throw new Error("模块定义不规范");ModuleDB.add(t)},invoke:function(){var t,e,n=toArray(arguments);return n.unshift(!1),t=c.apply(null,n),e=new Loader(t),new Promise(function(n){if(t.id&&!t.factory)e.fetch(function(r){r=merge(t,r),e.setModule(r),r.dep_ids.length>0?e.fetchDeps(function(t){u(n,r,t,!0)}):u(n,r,[])});else{if(t.id||!t.factory)throw new Error("模块调用不符合规范");t.dep_ids.length>0?e.fetchDeps(function(e){u(n,t,e)}):u(n,t,[])}})},use:function(t,e){this.invoke(t).then(e)["catch"](function(t){throw t})}}}();Injector.define("$class",function(){return Class}),Injector.define("$emitter",function(){return Emitter}),global.kvm={},merge(global.kvm,{isArray:isArray,isString:isString,isFunction:isFunction,isObject:isObject,isReference:isReference,isBoolean:isBoolean,isValue:isValue,isEmpty:isEmpty,toArray:toArray,forEach:forEach,merge:merge}),global.KVM=global.kvm,global.kvm.module=Injector,global.KVM.Module=Injector,global.define=Injector.define,global.define.amd=!0}(window);