/**
 ** kvm.js - 一款兼容AMD,angular模块规范同时支持依赖注入的模块管理器
 ** @author Janry
 ** @version v0.0.3
 **/
!function(global){function _type(e){return Object.prototype.toString.call(e)}function isReference(e){return isArray(e)||isObject(e)}function toArray(){var e;return e=[].slice.apply(arguments),[].slice.apply(e[0],e.slice(1))}function forEach(e,t,n){var r,i,o,c;if(isFunction(t)){if(isReference(e)){for(i=Object.keys(e),o=i.length,r=0,c=[],0==o&&isFunction(n)&&n();o>r&&t(e[i[r]],i[r])!==!1;)c.push(r++);return c}isFunction(n)&&n()}}function merge(){var e,t,n,r=!1,i=!0;return e=toArray(arguments),isBoolean(e[0])&&(r=e[0],e=e.slice(1)),isFunction(e[e.length-1])&&(n=e[e.length-1],e.pop()),isBoolean(e[e.length-1])&&(i=e[e.length-1],e.pop()),t=e.length,2>t?e[0]:2===t?(forEach(e[1],function(t,o){isFunction(n)&&n(o,e[0],e[1]),void 0!==e[1][o]&&null!==e[1][o]&&(i?(e[0][o]=e[0][o]||e[1][o].constructor(),r&&isReference(t)?merge(r,e[0][o],t,i,n):e[0][o]=t):e[0][o]||(e[0][o]=e[0][o]||e[1][o].constructor(),r&&isReference(t)?merge(r,e[0][o],t,i,n):e[0][o]=t))}),e[0]):merge(r,e[0],merge.apply(null,[r].concat(e.slice(1))))}function inherit(e,t){e.prototype.$super=function(){merge(this,t.apply(this,toArray(arguments)))}}function Emitter(e){this.__$$events__=e?e:{}}function Module(e){merge(this,e),this.$super()}for(var TYPES="Function,String,Array,Object,Number,Boolean".split(","),hasOwnProperty=Object.prototype.hasOwnProperty,i=0;i<TYPES.length;i++)eval("function is"+TYPES[i]+'(val){return _type(val) === "[object '+TYPES[i]+']"};');merge(Emitter.prototype,{$on:function(e,t){var n=this;return e=e.split(","),forEach(e,function(e){isFunction(t)&&(n.__$$events__[e]&&isArray(n.__$$events__[e])?n.__$$events__[e].push(t):n.__$$events__[e]=[t])}),this},$emit:function(e){var t=toArray(arguments),n=0,r=this.__$$events__[e];if(r&&isArray(r))for(n;n<r.length;n++)r[n].apply(null,t.slice(1));return this},$remove:function(e,t){var n=this.__$$events__[e];if(n&&isArray(n))if(t)for(var r=n.length-1;r>=0;r--)t===n[r]&&n.splice(r,1);else delete this.__$$events__[e];return this}});var Loader=function(){function e(e,n){function i(e){return o.results.push(e),o._checkDone()?(n(o.results),o._destroy(),!1):void 0}var o=this,c=Injector.data("shims");o.req_list=e,o.loaders=[],o.results=[],forEach(e,function(e){var n,s,u=Injector.resolve(e);if(forEach(r,function(e){return e.uri==u?(n=e,!1):void 0}),!n&&!(s=ModuleDB.get(e,u))){if(c[e])try{if(isFunction(c[e].checkConflict)){if(c[e].checkConflict()===!1)throw new Error("fake error");return i(Injector.define(e,c[e].factory))}throw new Error("fake error")}catch(a){n=new t(e,u,function(){Injector.define(e,c[e].factory)})}else n=new t(e,u);n&&r.push(n)}if(s)return i(s);if(n){if(n.module)return i(n.module);o.loaders.push(n),n.$on("loaded",function(e){return n.module=e,i(e)})}}),forEach(o.loaders,function(e){e.load()})}function t(e,t,n){this.id=e,this.uri=t,this.callback=n,this.module=null,this.$super()}function n(e){this.module=e}var r=[];return merge(e.prototype,{_destroy:function(){delete this.results,delete this.loaders,delete this.req_list},_checkDone:function(){return this.req_list.length==this.results.length}}),inherit(t,Emitter),merge(t.prototype,{load:function(){this._load(this.uri,this.callback)},_load:function(e,t){function n(e,t){function n(n){e.onload=e.onerror=e.onreadystatechange=null,Injector.debug||i.removeChild(e),e=null,t&&t(n)}var r="onload"in e;r?(e.onload=n,e.onerror=function(){n(!0)}):e.onreadystatechange=function(){/loaded|complete/.test(e.readyState)&&n()}}var r=document,i=r.head||r.getElementsByTagName("head")[0]||r.documentElement,o=i.getElementsByTagName("base")[0],c=r.createElement("script");c.async=!0,c.src=e,n(c,t),o?i.insertBefore(c,o):i.appendChild(c)}}),merge(n.prototype,{setModule:function(e){this.module=e},fetchDeps:function(e){var t=[],r=this;forEach(this.module.dep_ids,function(e){r.module.injectors&&r.module.injectors[e]||t.push(e)}),n.fetchList(t,e)},fetch:function(e){n.fetchList([this.module.id],function(t){t&&t.length>0&&isFunction(e)&&e(t[0])})}}),merge(n,{getLoader:function(e,t,n){var t=t||Injector.resolve(e);if(!t)throw new Error("资源未标识");forEach(r,function(r){return r.uri&&r.uri==t||r.id&&r.id==e?(n(r),!1):void 0})},fetchList:function(){var t=[],n=toArray(arguments),r=n[n.length-1];isFunction(r)&&(n=n.slice(0,n.length-1),forEach(n,function(e){isArray(e)?t=t.concat(e):t.push(e)}),new e(t,r))}}),n}();inherit(Module,Emitter);var ModuleDB=function(){var e=[];return{add:function(t){var n=new Module(t);return this.get(t.id,t.uri)||(e.push(n),Loader.getLoader(t.id,t.uri,function(e){e.$emit("loaded",n)})),this},get:function(t,n){var r;return forEach(e,function(e){return e.id&&t&&e.id==t||e.uri&&n&&e.uri==n?(r=e,!1):void 0}),r}}}(),Injector=function(){function e(){var e=document,t=e.head||e.getElementsByTagName("head")[0]||e.documentElement;if(e.currentScript)return e.currentScript.src;var n;try{a.b.c()}catch(r){n=r.stack,!n&&window.opera&&(n=(String(r).match(/of linked script \S+/g)||[]).join(" "))}if(n)return n=n.split(/[@ ]/g).pop(),n="("==n[0]?n.slice(1,-1):n,n.replace(/(:\d+)?:\d+$/i,"");for(var i,o=t.getElementsByTagName("script"),c=0;i=o[c++];)if("interactive"===i.readyState)return i.className=i.src}function t(e,t){return n(e,t.replace(/\.js/,""))+".js"}function n(){var e=arguments.length;if(0===e)throw new Error("resolveUrl requires at least one argument; got none.");var t=document.createElement("base");if(t.href=arguments[0],1===e)return t.href;var n=document.getElementsByTagName("head")[0];n.insertBefore(t,n.firstChild);for(var r,i=document.createElement("a"),o=1;e>o;o++)i.href=arguments[o],r=i.href,t.href=r;return n.removeChild(t),r}function r(e){return isFunction(e)||isArray(e)&&isFunction(e[e.length-1])}function i(e){var t=!0;return isArray(e)?(forEach(e,function(e){return isString(e)?void 0:t=!1}),t):!1}function o(){var t,n=toArray(arguments),o="",c="",s=[],u=null,a=!0;return isBoolean(n[0])?(a=n[0],n=n.slice(1,4)):n=n.slice(0,3),forEach(n,function(e){r(e)?isFunction(e)?t=e:(t=e[e.length-1],s=e.slice(0,e.length-1)):i(e)?s=e:isString(e)?(o=e,c=Injector.resolve(o)):isObject(e)&&(u=e)}),!c&&a&&(c=e()),new Module({uri:c,id:o,dep_ids:s,factory:t,injectors:u})}function c(e,t,n,r){function i(n,i){var s;i&&(o[n]=i,c++),c==t.dep_ids.length&&(s=r?t.instance?t.instance:t.instance=t.factory.apply(null,o):t.factory.apply(null,o),e(s))}var o=[],c=0;r=isBoolean(r)?r:!1,forEach(t.dep_ids,function(e,o){t.injectors&&t.injectors[e]?Injector.invoke(t.injectors[e]).then(function(e){i(o,e)})["catch"](function(e){throw e}):forEach(n,function(t){(t.id&&t.id==e||t.uri&&t.uri==Injector.resolve(e))&&(t.instance&&r&&i(o,t.instance),Injector.invoke(e).then(function(e){i(o,e)})["catch"](function(e){throw e}))})},function(){i()})}function s(e){if(!isString(e))throw new Error("路径类型错误");var t,n=/\{([^{}]+)\}/g;return t=e.replace(n,function(e,t){return u.vars[t]?u.vars[t]:t}),n.test(t)?tmp(t):t}var u={baseUrl:window.location.href,shims:{},vars:{},alias:{}};return{config:function(e){merge(u,e)},resolve:function(e){return e=s(u.shims[e]?u.shims[e].url||u.shims[e].uri:u.alias[e]?u.alias[e]:e),t(u.baseUrl,e)},data:function(e){return e?u[e]:u},define:function(){var e=o.apply(null,toArray(arguments));if(!e.uri||!e.factory)throw new Error("模块定义不规范");ModuleDB.add(e)},invoke:function(){var e,t,n=toArray(arguments);return n.unshift(!1),e=o.apply(null,n),t=new Loader(e),new Promise(function(n){if(e.id&&!e.factory)t.fetch(function(r){r=merge(e,r),t.setModule(r),r.dep_ids.length>0?t.fetchDeps(function(e){c(n,r,e,!0)}):c(n,r,[])});else{if(e.id||!e.factory)throw new Error("模块调用不符合规范");e.dep_ids.length>0?t.fetchDeps(function(t){c(n,e,t)}):c(n,e,[])}})},use:function(e,t){this.invoke(e).then(t)["catch"](function(e){throw e})}}}();Injector.define("$emitter",function(){return Emitter}),global.kvm={},merge(global.kvm,{isArray:isArray,isString:isString,isFunction:isFunction,isObject:isObject,isReference:isReference,isBoolean:isBoolean,toArray:toArray,forEach:forEach,merge:merge}),global.KVM=global.kvm,global.kvm.module=Injector,global.KVM.Module=Injector,global.define=Injector.define}(window);