/**
 ** kvm.js - 一款兼容AMD,CMD,angular模块规范同时支持依赖注入的模块管理器
 ** @author Janry
 ** @version v0.1.8
 **/
!function(global){function _type(t){return Object.prototype.toString.call(t)}function isReference(t){return isArray(t)||isObject(t)}function isValue(t){return!isReference(t)}function isEmpty(t){if(null==t)return!0;if(t.length>0)return!1;if(0===t.length)return!0;for(var e in t)if(hasOwnProperty.call(t,e))return!1;return!0}function toArray(){var t;return t=[].slice.apply(arguments),[].slice.apply(t[0],t.slice(1))}function getKeyLength(t){return isArray(t)?t.length:isObject(t)?Object.keys(t).length:0}function unique(t){for(var e=0;e<t.length;++e)for(var r=e+1;r<t.length;++r)t[e]===t[r]&&t.splice(r--,1);return t}function bind(t,e){var r=toArray(arguments);return r=r.slice(2),function(){return isFunction(t)?t.apply(e,toArray(arguments).concat(r)):void 0}}function forEach(t,e,r){var n,i,s,o;if(isFunction(e)){if(isReference(t)){for(i=Object.keys(t),s=i.length,n=0,o=[],0==s&&isFunction(r)&&r();s>n&&e(t[i[n]],i[n])!==!1;)o.push(n++);return o}isFunction(r)&&r()}}function guid(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()}function eachTask(){var t,e,r,n=toArray(arguments),i=[];isArray(n[0])&&(t=n[0],2==n.length&&(r=n[1]),n.length>2&&(e=n[1],r=n[2]),function s(t,n){var o,a,u=t.length;u>n&&(o=function(){i=toArray(arguments),u>n+1?s(t,n+1):r.apply(null,i)},a=function(){i=toArray(arguments),isFunction(e)?(i.unshift(o),e.apply(null,i)):u>n+1?s(t,n+1):r.apply(null,i)},isFunction(t[n])?(i.unshift(a),t[n].apply(null,i)):isFunction(e)&&(i=[t[n],o],e.apply(null,i)))}(t,0))}function merge(){var t,e,r,n=!1,i=!0;return t=toArray(arguments),isBoolean(t[0])&&(n=t[0],t=t.slice(1)),isFunction(t[t.length-1])&&(r=t[t.length-1],t.pop()),isBoolean(t[t.length-1])&&(i=t[t.length-1],t.pop()),e=t.length,2>e?t[0]:2===e?(forEach(t[1],function(e,s){isFunction(r)&&r(s,t[0],t[1]),void 0!==t[1][s]&&null!==t[1][s]&&(i?(isReference(t[1][s])&&(t[0][s]=t[0][s]||(isArray(t[1][s])?[]:{})),n&&isReference(e)?merge(n,t[0][s],e,i,r):t[0][s]=e):t[0][s]||(isReference(t[1][s])&&(t[0][s]=t[0][s]||(isArray(t[1][s])?[]:{})),n&&isReference(e)?merge(n,t[0][s],e,i,r):t[0][s]=e))}),t[0]):merge(n,t[0],merge.apply(null,[n].concat(t.slice(1))))}function copy(){var t,e,r,n,i,s;return t=toArray(arguments),r=!1,isBoolean(t[0])&&(r=t[0]===!0?!0:!1,t=t.slice(1)),isValue(t[0])?t[0]:(e=t[1]&&isFunction(t[1])?t[1]:!1,i=t[2]&&isString(t[2])?t[2]:"",n=isArray(t[0])?1:2,s=t[0].constructor(),forEach(t[0],function(t,o){var a,u;u=i?2===n?i+"."+o:i+"["+o+"]":o,e?(a=e(t,o,u),isBoolean(a)?a&&r&&isReference(t)?(s[o]=copy(r,t,e,u),u=i):s[o]=t:r&&isReference(t)?(s[o]=copy(r,t,e,u),u=i):s[o]=t):r&&isReference(t)?(s[o]=copy(r,t,e,u),u=i):s[o]=t}),s)}function Class(t,e){return t&&t.constructor&&isFunction(t.constructor)&&t.constructor!==Object?(_class=function(){return t.constructor.apply(this,toArray(arguments))},_class.toString=function(){return t.constructor.toString()}):_class=function(){},merge(_class.prototype,t),merge(_class,e),_class}for(var TYPES="Function,String,Array,Object,Number,Boolean".split(","),hasOwnProperty=Object.prototype.hasOwnProperty,i=0;i<TYPES.length;i++)eval("function is"+TYPES[i]+'(val){return _type(val) === "[object '+TYPES[i]+']"};');Class.inherit=function(){function t(t,e){function r(){return t.apply(this,e)}return r.prototype=t.prototype,new r}function e(){var r=t(i,toArray(arguments));return merge(this,r,!1),this.$super=e,this.$parent&&isArray(this.$parent)?this.$parent.push(r):this.$parent=[r],r}var r=toArray(arguments);if(2==r.length){var n=r[0],i=r[1];isFunction(n)&&isFunction(i)&&(merge(n.prototype,i.prototype,!1,function(t,e,r){if(r.$$isprotocol===!0&&isFunction(r[t])&&!isFunction(e[t]))throw"The subclass does not follow protocol"}),n.prototype.$super=e,n.prototype.$parent=i.prototype,n.prototype.constructor=n)}else if(r.length>2)for(var s=1;s<r.length;s++)Class.inherit(r[0],r[s])},Class.extend=function(t,e,r){isFunction(t)&&(merge(t.prototype,e),merge(t,r))},Class.protocol=function(t){return t.$$isprotocol=!0,Class(t)};var Emitter=Class({constructor:function(t){this.__$$events__=t?t:{}},$on:function(t,e){var r=this;return t=t.split(","),forEach(t,function(t){isFunction(e)&&(r.__$$events__[t]&&isArray(r.__$$events__[t])?r.__$$events__[t].push(e):r.__$$events__[t]=[e])}),this},$one:function(t,e){var r=this;return t=t.split(","),forEach(t,function(t){isFunction(e)&&(r.__$$events__[t]||(r.__$$events__[t]=[e]))}),this},$emit:function(t){var e=toArray(arguments),r=0,n=this.__$$events__[t];if(n&&isArray(n))for(r;r<n.length;r++)n[r].apply(null,e.slice(1));return this},$remove:function(t,e){var r=this.__$$events__[t];if(r&&isArray(r))if(e)for(var n=r.length-1;n>=0;n--)e===r[n]&&r.splice(n,1);else delete this.__$$events__[t];return this}}),Manager=function(){var t=new Emitter,e={baseUrl:window.location.href,vars:{},packages:{},alias:{},shims:{}},r={MODULES:{},add:function(t){var e=t.path,r=t.path.id||t.path.uri,n=i.Driver.getDriver(e);return this.MODULES[r]||(this.MODULES[r]=t,n&&n.$emit("loaded",t)),this.MODULES[r]},get:function(t){return this.MODULES[t.id||t.uri]||this.MODULES[t.id]||this.MODULES[t.uri]}},n={Module:Class({constructor:function(){this.$super(),this._init.apply(this,toArray(arguments))},_init:function(e){merge(this,{path:null,depPaths:[],factory:null,injectors:{},installed:!1,module:{exports:null}},e),t.$emit("MODULE_PARSER",this)},_collectDeps:function(){var t,e=this,r=[];return i.Request.fetch(this,this.depPaths).then(function(n){return new Promise(function(i){forEach(e.depPaths,function(s,o){t=s.getMap(n),t&&(r[o]=t.invoke(),r.length==e.depPaths.length&&i(Promise.all(r)))},function(){i(Promise.all([]))})})})},_inject:function(){var t=this;return this._collectDeps().then(function(e){var r=t.factory.apply(null,e);return t.module.exports?r=t.module.exports:t.module.exports=r,t.installed=!0,r})},getInjector:function(t){var e=this.injectors[t.id];return e?i.Module.createModule(t.id,e):void 0},invoke:function(){var t=this;return new Promise(function(e){if(t.installed)e(Promise.resolve(t.module.exports));else if(t.factory)e(Promise.resolve(t._inject()));else{if(!t.path||t.factory)throw new Error("模块不符合规范!");e(i.Request.fetch(t,t.path).then(function(t){return Promise.resolve(t[0]._inject())}))}})}},{createModule:function(){return new i.Module(i.Module.parseMeta.apply(null,toArray(arguments)))},parseMeta:function(){var t={},e=toArray(arguments),r=!1;return isBoolean(e[0])&&(r=e[0],e=e.slice(1)),forEach(e,function(e){isFunction(e)?t.factory=e:isArray(e)?isFunction(e[e.length-1])?(t.factory=e[e.length-1],t.depPaths=e.slice(0,e.length-1).map(function(t){return new i.Path(t)})):t.depPaths=e.map(function(t){return new i.Path(t)}):isString(e)?t.path=new i.Path(e):isObject(e)&&(t.injectors=e)}),!t.path&&r&&(t.path=new i.Path),t},registerModuleParser:function(e){isFunction(e)&&t.$on("MODULE_PARSER",function(t){e.call(t)})}}),Request:Class({constructor:function(){this.$super(),this._init.apply(this,toArray(arguments))},_init:function(t,e,r){this.sender=t,this.reqs=isArray(e)?e:[e],this.drivers=[],this.results=[],this.callback=r,this._parseReqs(),this.send()},_createDriver:function(t){var e=i.Driver.getDriver(t),r=this;e||(e=new i.Driver(t),e.beforeLoad(),e.module?r._done(e.module):this.drivers.push(e)),e.module?r._done(e.module):e.$on("loaded",function(t){e.module=t,r._done(t)})},_parseReqs:function(){var t,e=this;forEach(this.reqs,function(r){t=e.sender.getInjector(r),t=t||r.getModule(),t?e._done(t):e._createDriver(r)},function(){e.callback([])})},send:function(){forEach(this.drivers,function(t){t.load()})},_checkDone:function(){return this.reqs.length==this.results.length},_done:function(t){this.results.push(t),this._checkDone()&&isFunction(this.callback)&&this.callback(this.results)}},{fetch:function(t,e){return e=isArray(e)?e:[e],new Promise(function(r){new i.Request(t,e,function(t){r(t)})})}}),Driver:Class({constructor:function(){this.$super(),this._init.apply(this,toArray(arguments))},_init:function(t){this.path=t,this.module=null,i.Driver.getDriver(t)||i.Driver.addDriver(this)},loaded:function(e,r){var n=this.path;"js"!=n.ext?o.define(n.id,function(){return r}):t.$emit("DRIVER_LOADED",this,e,r)},beforeLoad:function(){t.$emit("DRIVER_BEFORE_LOAD",this)},load:function(){var e=this.path;"js"!=e.ext?t.$emit("DRIVER_LOADER_"+e.ext.toLocaleUpperCase(),this):this._loadJS(e.uri,bind(this.loaded,this))},_loadJS:function(t,e){function r(t,e){function r(r){t.onload=t.onerror=t.onreadystatechange=null,Manager.data("debug")&&i.removeChild(t),t=null,e&&e(r)}var n="onload"in t;n?(t.onload=r,t.onerror=function(){r(!0)}):t.onreadystatechange=function(){/loaded|complete/.test(t.readyState)&&r()}}var n=document,i=n.head||n.getElementsByTagName("head")[0]||n.documentElement,s=i.getElementsByTagName("base")[0],o=n.createElement("script");o.async=!0,o.src=t,r(o,e),s?i.insertBefore(o,s):i.appendChild(o)}},{DRIVERS:{},getDriver:function(t){return this.DRIVERS[t.uri]},addDriver:function(t){this.DRIVERS[t.path.uri]=t},registerDriverLoaded:function(e){isFunction(e)&&t.$on("DRIVER_LOADED",function(t){e.call(t)})},registerDriverLoader:function(e,r){isFunction(r)&&(e=e.trim(),e=e.toUpperCase(),t.$one("DRIVER_LOADER_"+e,function(t){r.call(t,t.path.uri,bind(t.loaded,t))}))},registerDriverBeforeLoad:function(e,r,n){isFunction(e)&&t.$on("DRIVER_BEFORE_LOAD",function(t){e.call(t,r,n)})}}),Path:Class({constructor:function(){this.$super(),this._init.apply(this,toArray(arguments))},_init:function(t,r){this.baseUrl=r||e.baseUrl,this.id=t||"",this._initId(),this._maper(),this._parser(),this._initUri()},__EXTS__:["js","css","json","jsonp","tpl","html"],_initId:function(){if(this.id){var t=document.createElement("a");t.href=this.id,this.query=this.getQuery(t.search),this.hash=t.hash.replace("#",""),this.id=this.id.replace(/(#|\?).*/,"")}},_initUri:function(){this.baseUrl=this.baseUrl.replace(/\/$/,"")+"/",this.uri=this.uri?this.resolvePath(this.baseUrl,this.uri):this.id?this.resolvePath(this.baseUrl,this.id):this.getCurrentScript(),this._initExt()},_initExt:function(){var t=this.uri.match(/\.(\w+)$/);t&&t[1]?(t=t[1].toLocaleLowerCase(),-1!=this.__EXTS__.indexOf(t)?this.ext=t:(this.$emit("FILE_EXTS_PARSER",this),this.__EXTS__.indexOf(this.ext)||(this.ext="js"))):(this.ext="js",this.uri+=".js")},_maper:function(){this.id&&t.$emit("PATH_MAPER",this)},_parser:function(){this.id&&(this._parseVars(),t.$emit("PATH_PARSER",this))},_parseVars:function(){this.baseUrl=this.template(this.baseUrl),this.id=this.template(this.id)},getModule:function(){return r.get(this)},equal:function(t){return this.id&&this.id==t.id||this.uri&&this.uri==t.uri},getMap:function(t){var e,r=this;if(isArray(t))forEach(t,function(t){return t.equal&&t.equal(r)||t.path&&t.path.equal(r)?(e=t,!1):void 0});else if(isObject(t))return t&&t[this.id||this.uri];return e},template:function(t){if(!isString(t))throw new Error("路径类型错误");var r,n=/\{([^{}]+)\}/g,i=this;return r=t.replace(n,function(t,r){return e.vars&&e.vars[r]?e.vars[r]:r}),n.test(r)?i.template(r):r},getQuery:function(t){for(var e=t.replace("?","").split("&"),r={},n=0;n<e.length;n++){var i=e[n].split("=");r[decodeURIComponent(i[0])]=decodeURIComponent(i[1])}return r},isAbsolutePath:function(t){var e=new RegExp("^(?:[a-z]+:)?//","i");return e.test(t)},resolvePath:function(){var t=arguments.length;if(0===t)throw new Error("resolveUrl requires at least one argument; got none.");var e=document.createElement("base");if(e.href=arguments[0],1===t)return e.href;var r=document.getElementsByTagName("head")[0];r.insertBefore(e,r.firstChild);for(var n,i=document.createElement("a"),s=1;t>s;s++)i.href=arguments[s],n=i.href,e.href=n;return r.removeChild(e),n},getCurrentScript:function(){var t=document,e=t.head||t.getElementsByTagName("head")[0]||t.documentElement;if(t.currentScript)return t.currentScript.src;var r;try{a.b.c()}catch(n){r=n.stack,!r&&window.opera&&(r=(String(n).match(/of linked script \S+/g)||[]).join(" "))}if(r)return r=r.split(/[@ ]/g).pop(),r="("==r[0]?r.slice(1,-1):r,r.replace(/(:\d+)?:\d+$/i,"");for(var i,s=e.getElementsByTagName("script"),o=0;i=s[o++];)if("interactive"===i.readyState)return i.className=i.src}},{registerFileExtParser:function(e){isFunction(e)&&t.$on("FILE_EXTS_PARSER",function(t){e.call(t)})},registerPathParser:function(e){isFunction(e)&&t.$on("PATH_PARSER",function(t){e.call(t)})},registerPathMaper:function(e){isFunction(e)&&t.$on("PATH_MAPER",function(t){e.call(t)})},createPath:function(t,e){return new i.Path(t,e)}})},i=n,s={registerModuleParser:i.Module.registerModuleParser,registerDriverLoader:i.Driver.registerDriverLoader,registerDriverLoaded:i.Driver.registerDriverLoaded,registerDriverBeforeLoad:i.Driver.registerDriverBeforeLoad,registerFileExtParser:i.Path.registerFileExtParser,registerPathParser:i.Path.registerPathParser,registerPathMaper:i.Path.registerPathMaper,createModule:i.Module.createModule,createPath:i.Path.createPath};if(forEach(n,function(t,e){Class.inherit(n[e],Emitter)}),!global.Promise)throw"浏览器不支持Promise,请升级浏览器再使用该管理器！或者使用kvm-promise.js";var o={config:function(t){return merge(!0,e,t),this},data:function(t){return e[t]?e[t]:e},define:function(){return r.add(i.Module.createModule.apply(null,[!0].concat(toArray(arguments)))),this},invoke:function(){return i.Module.createModule.apply(null,toArray(arguments)).invoke()},use:function(t,e){var r=i.Module.createModule(t);r.invoke(function(t){isFunction(e)&&e(t)})["catch"](function(t){throw t})},registerPlugin:function(t){isFunction(t)&&t.call(this,s)}};return o}();Manager.define("$class",function(){return Class}),Manager.define("$emitter",function(){return Emitter}),global.kvm={},merge(global.kvm,{isArray:isArray,isString:isString,isFunction:isFunction,isObject:isObject,isReference:isReference,isEmpty:isEmpty,isBoolean:isBoolean,getKeyLength:getKeyLength,isValue:isValue,guid:guid,unique:unique,toArray:toArray,bind:bind,forEach:forEach,merge:merge,eachTask:eachTask,copy:copy,Class:Class,Emitter:Emitter}),global.KVM=global.kvm,global.kvm.module=Manager,global.KVM.Module=Manager,global.define=Manager.define,global.define.amd=!0}(window);