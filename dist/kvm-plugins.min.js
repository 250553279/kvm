/**
 ** kvm.js - 一款兼容AMD,CMD,angular模块规范同时支持依赖注入的模块管理器
 ** @author Janry
 ** @version v0.2.1
 **/
!function(){kvm.module.registerPlugin(function(e){e.registerPathMaper(function(){var e=kvm.module.data("alias");kvm.isAbsolutePath(this.id)||e[this.id]&&(this.uri=e[this.id],this._parser())})})}(),function(){kvm.module.registerPlugin(function(e){e.registerModuleParser(function(){function t(e){var t,i;for(t=0;t<e.length;t++)for(i=t+1;i<e.length;i++)e[t].equal(e[i])&&e.splice(i,1);return e}function i(e){var t=!1;return e.forEach(function(e){return"require"==e.id?(t=!0,!1):void 0}),t}this.injectCommonjs=function(){var t=this;this.injectors.exports=function(){return t.module.exports=t.module.exports||{},t.module.exports},this.injectors.module=function(){return t.module},this.injectors.require=function(){return function(t){var i=e.createPath(t),n=i.getModule();return n&&n.module&&n.module.exports?n.module.exports:{}}}},this.collectDeps=function(){var i;kvm.isFunction(this.factory)&&(i=this.parseDependencies(this.factory.toString()),i=i.map(function(t){return e.createPath(t)}),this.depPaths=t(this.depPaths.concat(i)))},this.parseDependencies=function(e){function t(){c=e.charAt(f++)}function i(){return/\s/.test(c)}function n(){return'"'==c||"'"==c}function r(){var i=f,n=c,r=e.indexOf(n,i);if(-1==r)f=l;else if("\\"!=e.charAt(r-1))f=r+1;else for(;l>f;)if(t(),"\\"==c)f++;else if(c==n)break;m&&(g.push(e.slice(i,f-1)),m=0)}function s(){for(f--;l>f;)if(t(),"\\"==c)f++;else{if("/"==c)break;if("["==c)for(;l>f;)if(t(),"\\"==c)f++;else if("]"==c)break}}function o(){return/[a-z_$]/i.test(c)}function u(){var t=e.slice(f-1),i=/^[\w$]+/.exec(t)[0];p={"if":1,"for":1,"while":1,"with":1}[i],h={"break":1,"case":1,"continue":1,"debugger":1,"delete":1,"do":1,"else":1,"false":1,"if":1,"in":1,"instanceof":1,"return":1,"typeof":1,"void":1}[i],m=/^require\s*\(\s*(['"]).+?\1\s*\)/.test(t),m?(i=/^require\s*\(\s*['"]/.exec(t)[0],f+=i.length-2):f+=/^[\w$]+(?:\s*\.\s*[\w$]+)*/.exec(t)[0].length-1}function a(){return/\d/.test(c)||"."==c&&/\d/.test(e.charAt(f))}function d(){var t,i=e.slice(f-1);t="."==c?/^\.\d+(?:E[+-]?\d*)?\s*/i.exec(i)[0]:/^0x[\da-f]*/i.test(i)?/^0x[\da-f]*\s*/i.exec(i)[0]:/^\d+\.?\d*(?:E[+-]?\d*)?\s*/i.exec(i)[0],f+=t.length-1,h=0}if(-1==e.indexOf("require"))return[];for(var c,f=0,l=e.length,h=1,m=0,p=0,v=[],g=[];l>f;)t(),i()||(n()?(r(),h=1):"/"==c?(t(),"/"==c?(f=e.indexOf("\n",f),-1==f&&(f=e.length)):"*"==c?(f=e.indexOf("*/",f),-1==f?f=l:f+=2):h?(s(),h=0):(f--,h=1)):o()?u():a()?d():"("==c?(v.push(p),h=1):")"==c?h=v.pop():(h="]"!=c,m=0));return g},this.injectCommonjs(),this.factory&&i(this.depPaths)&&this.collectDeps()})})}(),function(){kvm.module.registerPlugin(function(e){e.registerDriverLoader("css",function(e,t){var i=document,n=i.head||i.getElementsByTagName("head")[0]||i.documentElement,r=window.document.createElement("link"),s=window.document.styleSheets,o=this;r.rel="stylesheet",r.href=e,r.media="only x",t&&(r.onload=function(){t&&t(null,r)},r.onerror=function(){t&&t(!0)}),n.appendChild(r),r.onloadcssdefined=function(t){for(var i,n=0;n<s.length;n++)s[n].href&&s[n].href.indexOf(e)>-1&&(i=!0);i?t():setTimeout(function(){r.onloadcssdefined(t)})},r.onloadcssdefined(function(){r.media=o.path.query&&o.path.query.media||"all"})}),e.registerDriverLoaded(function(e,t){var i=this.path;"css"!=i.ext||e||kvm.module.define(i.id,function(){return t})})})}(),function(){kvm.module.registerPlugin(function(e){var t=kvm.module.data();e.registerPathParser(function(){var e,i,n=t.baseUrl,r=t.packages,s=this.uri||this.id;s&&(i=s.indexOf("/"),e=s.substr(0,i),r&&r[e]&&(this.baseUrl=r[e].uri||r[e].url||n,this.uri=s.substr(i+1),this._parseVars()))})})}(),function(){kvm.module.registerPlugin(function(e){var t=kvm.module.data();e.registerPathMaper(function(){var e=t.shims[this.id];e&&(this.uri=e.uri||e.url,this._parser())}),e.registerDriverBeforeLoad(function(){var i=this.path,n=t.shims[i.id];n&&n.exports&&!n.factory&&window[n.exports]&&(this.module=e.createModule(i.id,function(){return window[n.exports]}))}),e.registerDriverLoaded(function(){var e=this.path,i=t.shims[e.id];i&&!e.getModule()&&(kvm.isFunction(i.factory)?kvm.module.define(e.id,i.factory):kvm.module.define(e.id,function(){return window[i.exports]}))})})}();