/**
 ** kvm.js - 一款兼容AMD,CMD,angular模块规范同时支持依赖注入的模块管理器
 ** @author Janry
 ** @version v0.1.8
 **/
!function(global){function _type(e){return Object.prototype.toString.call(e)}function isReference(e){return isArray(e)||isObject(e)}function isValue(e){return!isReference(e)}function isEmpty(e){if(null==e)return!0;if(e.length>0)return!1;if(0===e.length)return!0;for(var t in e)if(hasOwnProperty.call(e,t))return!1;return!0}function toArray(){var e;return e=[].slice.apply(arguments),[].slice.apply(e[0],e.slice(1))}function getKeyLength(e){return isArray(e)?e.length:isObject(e)?Object.keys(e).length:0}function unique(e){for(var t=0;t<e.length;++t)for(var r=t+1;r<e.length;++r)e[t]===e[r]&&e.splice(r--,1);return e}function bind(e,t){var r=toArray(arguments);return r=r.slice(2),function(){return isFunction(e)?e.apply(t,toArray(arguments).concat(r)):void 0}}function forEach(e,t,r){var n,i,o,s;if(isFunction(t)){if(isReference(e)){for(i=Object.keys(e),o=i.length,n=0,s=[],0==o&&isFunction(r)&&r();o>n&&t(e[i[n]],i[n])!==!1;)s.push(n++);return s}isFunction(r)&&r()}}function guid(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}function eachTask(){var e,t,r,n=toArray(arguments),i=[];isArray(n[0])&&(e=n[0],2==n.length&&(r=n[1]),n.length>2&&(t=n[1],r=n[2]),function o(e,n){var s,a,u=e.length;u>n&&(s=function(){i=toArray(arguments),u>n+1?o(e,n+1):r.apply(null,i)},a=function(){i=toArray(arguments),isFunction(t)?(i.unshift(s),t.apply(null,i)):u>n+1?o(e,n+1):r.apply(null,i)},isFunction(e[n])?(i.unshift(a),e[n].apply(null,i)):isFunction(t)&&(i=[e[n],s],t.apply(null,i)))}(e,0))}function merge(){var e,t,r,n=!1,i=!0;return e=toArray(arguments),isBoolean(e[0])&&(n=e[0],e=e.slice(1)),isFunction(e[e.length-1])&&(r=e[e.length-1],e.pop()),isBoolean(e[e.length-1])&&(i=e[e.length-1],e.pop()),t=e.length,2>t?e[0]:2===t?(forEach(e[1],function(t,o){isFunction(r)&&r(o,e[0],e[1]),void 0!==e[1][o]&&null!==e[1][o]&&(i?(isReference(e[1][o])&&(e[0][o]=e[0][o]||(isArray(e[1][o])?[]:{})),n&&isReference(t)?merge(n,e[0][o],t,i,r):e[0][o]=t):e[0][o]||(isReference(e[1][o])&&(e[0][o]=e[0][o]||(isArray(e[1][o])?[]:{})),n&&isReference(t)?merge(n,e[0][o],t,i,r):e[0][o]=t))}),e[0]):merge(n,e[0],merge.apply(null,[n].concat(e.slice(1))))}function copy(){var e,t,r,n,i,o;return e=toArray(arguments),r=!1,isBoolean(e[0])&&(r=e[0]===!0?!0:!1,e=e.slice(1)),isValue(e[0])?e[0]:(t=e[1]&&isFunction(e[1])?e[1]:!1,i=e[2]&&isString(e[2])?e[2]:"",n=isArray(e[0])?1:2,o=e[0].constructor(),forEach(e[0],function(e,s){var a,u;u=i?2===n?i+"."+s:i+"["+s+"]":s,t?(a=t(e,s,u),isBoolean(a)?a&&r&&isReference(e)?(o[s]=copy(r,e,t,u),u=i):o[s]=e:r&&isReference(e)?(o[s]=copy(r,e,t,u),u=i):o[s]=e):r&&isReference(e)?(o[s]=copy(r,e,t,u),u=i):o[s]=e}),o)}function Class(e,t){return e&&e.constructor&&isFunction(e.constructor)&&e.constructor!==Object?(_class=function(){return e.constructor.apply(this,toArray(arguments))},_class.toString=function(){return e.constructor.toString()}):_class=function(){},merge(_class.prototype,e),merge(_class,t),_class}for(var TYPES="Function,String,Array,Object,Number,Boolean".split(","),hasOwnProperty=Object.prototype.hasOwnProperty,i=0;i<TYPES.length;i++)eval("function is"+TYPES[i]+'(val){return _type(val) === "[object '+TYPES[i]+']"};');Class.inherit=function(){function e(e,t){function r(){return e.apply(this,t)}return r.prototype=e.prototype,new r}function t(){var r=e(i,toArray(arguments));return merge(this,r,!1),this.$super=t,this.$parent&&isArray(this.$parent)?this.$parent.push(r):this.$parent=[r],r}var r=toArray(arguments);if(2==r.length){var n=r[0],i=r[1];isFunction(n)&&isFunction(i)&&(merge(n.prototype,i.prototype,!1,function(e,t,r){if(r.$$isprotocol===!0&&isFunction(r[e])&&!isFunction(t[e]))throw"The subclass does not follow protocol"}),n.prototype.$super=t,n.prototype.$parent=i.prototype,n.prototype.constructor=n)}else if(r.length>2)for(var o=1;o<r.length;o++)Class.inherit(r[0],r[o])},Class.extend=function(e,t,r){isFunction(e)&&(merge(e.prototype,t),merge(e,r))},Class.protocol=function(e){return e.$$isprotocol=!0,Class(e)};var Emitter=Class({constructor:function(e){this.__$$events__=e?e:{}},$on:function(e,t){var r=this;return e=e.split(","),forEach(e,function(e){isFunction(t)&&(r.__$$events__[e]&&isArray(r.__$$events__[e])?r.__$$events__[e].push(t):r.__$$events__[e]=[t])}),this},$one:function(e,t){var r=this;return e=e.split(","),forEach(e,function(e){isFunction(t)&&(r.__$$events__[e]||(r.__$$events__[e]=[t]))}),this},$emit:function(e){var t=toArray(arguments),r=0,n=this.__$$events__[e];if(n&&isArray(n))for(r;r<n.length;r++)n[r].apply(null,t.slice(1));return this},$remove:function(e,t){var r=this.__$$events__[e];if(r&&isArray(r))if(t)for(var n=r.length-1;n>=0;n--)t===r[n]&&r.splice(n,1);else delete this.__$$events__[e];return this}}),Manager=function(){var e=new Emitter,t={baseUrl:window.location.href,vars:{},packages:{},alias:{},shims:{}},r={MODULES:{},add:function(e){var t=e.path,r=e.path.id||e.path.uri,n=i.Driver.getDriver(t);return this.MODULES[r]||(this.MODULES[r]=e,n&&n.$emit("loaded",e)),this.MODULES[r]},get:function(e){return this.MODULES[e.id||e.uri]||this.MODULES[e.id]||this.MODULES[e.uri]}},n={Module:Class({constructor:function(){this.$super(),this._init.apply(this,toArray(arguments))},_init:function(t){merge(this,{path:null,depPaths:[],factory:null,injectors:{},installed:!1,module:{exports:null}},t),e.$emit("MODULE_PARSER",this)},_collectDeps:function(){var e,t=this,r=[];return i.Request.fetch(this,this.depPaths).then(function(n){return new Promise(function(i){forEach(t.depPaths,function(o,s){e=o.getMap(n),e&&(r[s]=e.invoke(),r.length==t.depPaths.length&&i(Promise.all(r)))},function(){i(Promise.all([]))})})})},_inject:function(){var e=this;return this._collectDeps().then(function(t){var r=e.factory.apply(null,t);return e.module.exports?r=e.module.exports:e.module.exports=r,e.installed=!0,r})},getInjector:function(e){var t=this.injectors[e.id];return t?i.Module.createModule(e.id,t):void 0},invoke:function(){var e=this;return new Promise(function(t){if(e.installed)t(Promise.resolve(e.module.exports));else if(e.factory)t(Promise.resolve(e._inject()));else{if(!e.path||e.factory)throw new Error("模块不符合规范!");t(i.Request.fetch(e,e.path).then(function(e){return Promise.resolve(e[0]._inject())}))}})}},{createModule:function(){return new i.Module(i.Module.parseMeta.apply(null,toArray(arguments)))},parseMeta:function(){var e={},t=toArray(arguments),r=!1;return isBoolean(t[0])&&(r=t[0],t=t.slice(1)),forEach(t,function(t){isFunction(t)?e.factory=t:isArray(t)?isFunction(t[t.length-1])?(e.factory=t[t.length-1],e.depPaths=t.slice(0,t.length-1).map(function(e){return new i.Path(e)})):e.depPaths=t.map(function(e){return new i.Path(e)}):isString(t)?e.path=new i.Path(t):isObject(t)&&(e.injectors=t)}),!e.path&&r&&(e.path=new i.Path),e},registerModuleParser:function(t){isFunction(t)&&e.$on("MODULE_PARSER",function(e){t.call(e)})}}),Request:Class({constructor:function(){this.$super(),this._init.apply(this,toArray(arguments))},_init:function(e,t,r){this.sender=e,this.reqs=isArray(t)?t:[t],this.drivers=[],this.results=[],this.callback=r,this._parseReqs(),this.send()},_createDriver:function(e){var t=i.Driver.getDriver(e),r=this;t||(t=new i.Driver(e),t.beforeLoad(),t.module?r._done(t.module):this.drivers.push(t)),t.module?r._done(t.module):t.$on("loaded",function(e){t.module=e,r._done(e)})},_parseReqs:function(){var e,t=this;forEach(this.reqs,function(r){e=t.sender.getInjector(r),e=e||r.getModule(),e?t._done(e):t._createDriver(r)},function(){t.callback([])})},send:function(){forEach(this.drivers,function(e){e.load()})},_checkDone:function(){return this.reqs.length==this.results.length},_done:function(e){this.results.push(e),this._checkDone()&&isFunction(this.callback)&&this.callback(this.results)}},{fetch:function(e,t){return t=isArray(t)?t:[t],new Promise(function(r){new i.Request(e,t,function(e){r(e)})})}}),Driver:Class({constructor:function(){this.$super(),this._init.apply(this,toArray(arguments))},_init:function(e){this.path=e,this.module=null,i.Driver.getDriver(e)||i.Driver.addDriver(this)},loaded:function(t,r){var n=this.path;"js"!=n.ext?s.define(n.id,function(){return r}):e.$emit("DRIVER_LOADED",this,t,r)},beforeLoad:function(){e.$emit("DRIVER_BEFORE_LOAD",this)},load:function(){var t=this.path;"js"!=t.ext?e.$emit("DRIVER_LOADER_"+t.ext.toLocaleUpperCase(),this):this._loadJS(t.uri,bind(this.loaded,this))},_loadJS:function(e,t){function r(e,t){function r(r){e.onload=e.onerror=e.onreadystatechange=null,Manager.data("debug")&&i.removeChild(e),e=null,t&&t(r)}var n="onload"in e;n?(e.onload=r,e.onerror=function(){r(!0)}):e.onreadystatechange=function(){/loaded|complete/.test(e.readyState)&&r()}}var n=document,i=n.head||n.getElementsByTagName("head")[0]||n.documentElement,o=i.getElementsByTagName("base")[0],s=n.createElement("script");s.async=!0,s.src=e,r(s,t),o?i.insertBefore(s,o):i.appendChild(s)}},{DRIVERS:{},getDriver:function(e){return this.DRIVERS[e.uri]},addDriver:function(e){this.DRIVERS[e.path.uri]=e},registerDriverLoaded:function(t){isFunction(t)&&e.$on("DRIVER_LOADED",function(e){t.call(e)})},registerDriverLoader:function(t,r){isFunction(r)&&(t=t.trim(),t=t.toUpperCase(),e.$one("DRIVER_LOADER_"+t,function(e){r.call(e,e.path.uri,bind(e.loaded,e))}))},registerDriverBeforeLoad:function(t,r,n){isFunction(t)&&e.$on("DRIVER_BEFORE_LOAD",function(e){t.call(e,r,n)})}}),Path:Class({constructor:function(){this.$super(),this._init.apply(this,toArray(arguments))},_init:function(e,r){this.baseUrl=r||t.baseUrl,this.id=e||"",this._initId(),this._maper(),this._parser(),this._initUri()},__EXTS__:["js","css","json","jsonp","tpl","html"],_initId:function(){if(this.id){var e=document.createElement("a");e.href=this.id,this.query=this.getQuery(e.search),this.hash=e.hash.replace("#",""),this.id=this.id.replace(/(#|\?).*/,"")}},_initUri:function(){this.baseUrl=this.baseUrl.replace(/\/$/,"")+"/",this.uri=this.uri?this.resolvePath(this.baseUrl,this.uri):this.id?this.resolvePath(this.baseUrl,this.id):this.getCurrentScript(),this._initExt()},_initExt:function(){var e=this.uri.match(/\.(\w+)$/);e&&e[1]?(e=e[1].toLocaleLowerCase(),-1!=this.__EXTS__.indexOf(e)?this.ext=e:(this.$emit("FILE_EXTS_PARSER",this),this.__EXTS__.indexOf(this.ext)||(this.ext="js"))):(this.ext="js",this.uri+=".js")},_maper:function(){this.id&&e.$emit("PATH_MAPER",this)},_parser:function(){this.id&&(this._parseVars(),e.$emit("PATH_PARSER",this))},_parseVars:function(){this.baseUrl=this.template(this.baseUrl),this.id=this.template(this.id)},getModule:function(){return r.get(this)},equal:function(e){return this.id&&this.id==e.id||this.uri&&this.uri==e.uri},getMap:function(e){var t,r=this;if(isArray(e))forEach(e,function(e){return e.equal&&e.equal(r)||e.path&&e.path.equal(r)?(t=e,!1):void 0});else if(isObject(e))return e&&e[this.id||this.uri];return t},template:function(e){if(!isString(e))throw new Error("路径类型错误");var r,n=/\{([^{}]+)\}/g,i=this;return r=e.replace(n,function(e,r){return t.vars&&t.vars[r]?t.vars[r]:r}),n.test(r)?i.template(r):r},getQuery:function(e){for(var t=e.replace("?","").split("&"),r={},n=0;n<t.length;n++){var i=t[n].split("=");r[decodeURIComponent(i[0])]=decodeURIComponent(i[1])}return r},isAbsolutePath:function(e){var t=new RegExp("^(?:[a-z]+:)?//","i");return t.test(e)},resolvePath:function(){var e=arguments.length;if(0===e)throw new Error("resolveUrl requires at least one argument; got none.");var t=document.createElement("base");if(t.href=arguments[0],1===e)return t.href;var r=document.getElementsByTagName("head")[0];r.insertBefore(t,r.firstChild);for(var n,i=document.createElement("a"),o=1;e>o;o++)i.href=arguments[o],n=i.href,t.href=n;return r.removeChild(t),n},getCurrentScript:function(){var e=document,t=e.head||e.getElementsByTagName("head")[0]||e.documentElement;if(e.currentScript)return e.currentScript.src;var r;try{a.b.c()}catch(n){r=n.stack,!r&&window.opera&&(r=(String(n).match(/of linked script \S+/g)||[]).join(" "))}if(r)return r=r.split(/[@ ]/g).pop(),r="("==r[0]?r.slice(1,-1):r,r.replace(/(:\d+)?:\d+$/i,"");for(var i,o=t.getElementsByTagName("script"),s=0;i=o[s++];)if("interactive"===i.readyState)return i.className=i.src}},{registerFileExtParser:function(t){isFunction(t)&&e.$on("FILE_EXTS_PARSER",function(e){t.call(e)})},registerPathParser:function(t){isFunction(t)&&e.$on("PATH_PARSER",function(e){t.call(e)})},registerPathMaper:function(t){isFunction(t)&&e.$on("PATH_MAPER",function(e){t.call(e)})},createPath:function(e,t){return new i.Path(e,t)}})},i=n,o={registerModuleParser:i.Module.registerModuleParser,registerDriverLoader:i.Driver.registerDriverLoader,registerDriverLoaded:i.Driver.registerDriverLoaded,registerDriverBeforeLoad:i.Driver.registerDriverBeforeLoad,registerFileExtParser:i.Path.registerFileExtParser,registerPathParser:i.Path.registerPathParser,registerPathMaper:i.Path.registerPathMaper,createModule:i.Module.createModule,createPath:i.Path.createPath};if(forEach(n,function(e,t){Class.inherit(n[t],Emitter)}),!global.Promise)throw"浏览器不支持Promise,请升级浏览器再使用该管理器！或者使用kvm-promise.js";var s={config:function(e){return merge(!0,t,e),this},data:function(e){return t[e]?t[e]:t},define:function(){return r.add(i.Module.createModule.apply(null,[!0].concat(toArray(arguments)))),this},invoke:function(){return i.Module.createModule.apply(null,toArray(arguments)).invoke()},use:function(e,t){var r=i.Module.createModule(e);r.invoke(function(e){isFunction(t)&&t(e)})["catch"](function(e){throw e})},registerPlugin:function(e){isFunction(e)&&e.call(this,o)}};return s}();Manager.define("$class",function(){return Class}),Manager.define("$emitter",function(){return Emitter}),global.kvm={},merge(global.kvm,{isArray:isArray,isString:isString,isFunction:isFunction,isObject:isObject,isReference:isReference,isEmpty:isEmpty,isBoolean:isBoolean,getKeyLength:getKeyLength,isValue:isValue,guid:guid,unique:unique,toArray:toArray,bind:bind,forEach:forEach,merge:merge,eachTask:eachTask,copy:copy,Class:Class,Emitter:Emitter}),global.KVM=global.kvm,global.kvm.module=Manager,global.KVM.Module=Manager,global.define=Manager.define,global.define.amd=!0}(window),function(){kvm.module.registerPlugin(function(e){e.registerPathMaper(function(){var e=kvm.module.data("alias");this.isAbsolutePath(this.id)||e[this.id]&&(this.uri=e[this.id],this._parser())})})}(),function(){kvm.module.registerPlugin(function(e){e.registerModuleParser(function(){function t(e){var t,r;for(t=0;t<e.length;t++)for(r=t+1;r<e.length;r++)e[t].equal(e[r])&&e.splice(r,1);return e}function r(e){var t=!1;return kvm.forEach(e,function(e){return"require"==e.id?(t=!0,!1):void 0}),t}this.injectCommonjs=function(){var t=this;this.injectors.exports=function(){return t.module.exports=t.module.exports||{},t.module.exports},this.injectors.module=function(){return t.module},this.injectors.require=function(){return function(t){var r=e.createPath(t),n=r.getModule();return n&&n.module&&n.module.exports?n.module.exports:{}}}},this.collectDeps=function(){var r;kvm.isFunction(this.factory)&&(r=this.parseDependencies(this.factory.toString()),r=r.map(function(t){return e.createPath(t)}),this.depPaths=t(this.depPaths.concat(r)))},this.parseDependencies=function(e){function t(){l=e.charAt(f++)}function r(){return/\s/.test(l)}function n(){return'"'==l||"'"==l}function i(){var r=f,n=l,i=e.indexOf(n,r);if(-1==i)f=h;else if("\\"!=e.charAt(i-1))f=i+1;else for(;h>f;)if(t(),"\\"==l)f++;else if(l==n)break;p&&(g.push(e.slice(r,f-1)),p=0)}function o(){for(f--;h>f;)if(t(),"\\"==l)f++;else{if("/"==l)break;if("["==l)for(;h>f;)if(t(),"\\"==l)f++;else if("]"==l)break}}function s(){return/[a-z_$]/i.test(l)}function a(){var t=e.slice(f-1),r=/^[\w$]+/.exec(t)[0];m={"if":1,"for":1,"while":1,"with":1}[r],d={"break":1,"case":1,"continue":1,"debugger":1,"delete":1,"do":1,"else":1,"false":1,"if":1,"in":1,"instanceof":1,"return":1,"typeof":1,"void":1}[r],p=/^require\s*\(\s*(['"]).+?\1\s*\)/.test(t),p?(r=/^require\s*\(\s*['"]/.exec(t)[0],f+=r.length-2):f+=/^[\w$]+(?:\s*\.\s*[\w$]+)*/.exec(t)[0].length-1}function u(){return/\d/.test(l)||"."==l&&/\d/.test(e.charAt(f))}function c(){var t,r=e.slice(f-1);t="."==l?/^\.\d+(?:E[+-]?\d*)?\s*/i.exec(r)[0]:/^0x[\da-f]*/i.test(r)?/^0x[\da-f]*\s*/i.exec(r)[0]:/^\d+\.?\d*(?:E[+-]?\d*)?\s*/i.exec(r)[0],f+=t.length-1,d=0}if(-1==e.indexOf("require"))return[];for(var l,f=0,h=e.length,d=1,p=0,m=0,v=[],g=[];h>f;)t(),r()||(n()?(i(),d=1):"/"==l?(t(),"/"==l?(f=e.indexOf("\n",f),-1==f&&(f=e.length)):"*"==l?(f=e.indexOf("*/",f),-1==f?f=h:f+=2):d?(o(),d=0):(f--,d=1)):s()?a():u()?c():"("==l?(v.push(m),d=1):")"==l?d=v.pop():(d="]"!=l,p=0));return g},this.injectCommonjs(),this.factory&&r(this.depPaths)&&this.collectDeps()})})}(),function(){kvm.module.registerPlugin(function(e){e.registerDriverLoader("css",function(e,t){var r=document,n=r.head||r.getElementsByTagName("head")[0]||r.documentElement,i=window.document.createElement("link"),o=window.document.styleSheets,s=this;i.rel="stylesheet",i.href=e,i.media="only x",t&&(i.onload=function(){t&&t(null,i)},i.onerror=function(){t&&t(!0)}),n.appendChild(i),i.onloadcssdefined=function(t){for(var r,n=0;n<o.length;n++)o[n].href&&o[n].href.indexOf(e)>-1&&(r=!0);r?t():setTimeout(function(){i.onloadcssdefined(t)})},i.onloadcssdefined(function(){i.media=s.path.query&&s.path.query.media||"all"})}),e.registerDriverLoaded(function(e,t){var r=this.path;"css"!=r.ext||e||kvm.module.define(r.id,function(){return t})})})}(),define("$do",function(){function e(t,r,n){n=kvm.isBoolean(n)&&n===!1?!1:!0,kvm.isFunction(r)&&kvm.forEach(t,function(t,i){kvm.isReference(t)&&n?(r(t,i),e(t,r)):r(t,i)})}function t(e,t,r){var n,i;return n=!1,i=function(e,t){var r,n,i;for(r=e.length,n=t.length,i=0;n>i;){if(t.charAt(i)!==e.charAt(i))return!1;i++}if(i===n){if(r===n)return!0;if(r>n&&"[.".indexOf(e.charAt(n))>-1)return!0}},kvm.forEach(t,function(t){return n=r?i(t,e):i(e,t),n?!1:void 0}),n}function r(e,t){this.data=e,this._commands.__parent__=this,this._filters.__parent__=this,t&&this.exec(t)}var n={OPERATORS:"$remove,$set,$push,$slice,$concat,$pop,$unshift,$merge,$deep_merge,$clone,$find,$sort,$foreach".split(","),FILTERS:"$gt,$lt,$is,$not,$gte,$lte,$icontains,$contains,$in,$not_in,$and,$or".split(","),SORTS:"$desc,$asc".split(","),CLONES:"$white_list,$black_list,$filter,$deep".split(","),COMMONS:"$callback".split(",")},i=function(){var e,t,r,i,o,s;r={};for(t in n)for(s=n[t],i=0,o=s.length;o>i;i++)e=s[i],r[e]=!0;return r}();return kvm.merge(r.prototype,{_collect:function(e){var t,r;if(r={operators:{},filters:{},sorts:{},clones:{},commons:{},props:{},value:null},!kvm.isReference(e))return r.value=e,r;for(t in e)n.OPERATORS.indexOf(t)>-1?r.operators[t]=e[t]:n.FILTERS.indexOf(t)>-1?r.filters[t]=e[t]:n.SORTS.indexOf(t)>-1?r.sorts[t]=e[t]:n.CLONES.indexOf(t)>-1?r.clones[t]=e[t]:n.COMMONS.indexOf(t)>-1?r.commons[t]=e[t]:r.props[t]=e[t];return r},_filters:{$is:function(e,t){return e===t},$not:function(e,t){return e!==t},$gt:function(e,t){return e>t},$lt:function(e,t){return t>e},$gte:function(e,t){return e>=t},$lte:function(e,t){return t>=e},$icontains:function(e,t){return e.toLowerCase().indexOf(t.toLowerCase())>-1},$contains:function(e,t){return e.indexOf(t)>-1},$in:function(e,t){return t.indexOf(e)>-1},$not_in:function(e,t){return-1===t.indexOf(e)}},_commands:{$set:function(e,t){var r,n,i,o;i=t.props,o=[];for(r in i)n=i[r],kvm.isReference(n)?(e[r]=e[r]||n.constructor(),o.push(this.$set(e[r],this.__parent__._collect(n)))):o.push(e[r]=n);return o},$remove:function(e,t){var r,n,i,o;i=t.props,o=[];for(r in i)n=i[r],o.push(kvm.isArray(e)||n!==!0?void 0:delete e[r]);return o},$slice:function(e,t){var r,n,i,o;i=t.props,o=[];for(r in i)n=i[r],e[r]&&kvm.isArray(e[r])?(kvm.isArray(n)||(n=[n]),o.push(e[r]=e[r].slice.apply(e[r],n))):o.push(void 0);return o},$push:function(e,t){var r,n,i,o;i=t.props,o=[];for(r in i)n=i[r],o.push(e[r]&&kvm.isArray(e[r])?e[r].push(n):void 0);return o},$concat:function(e,t){var r,n,i,o;i=t.props,o=[];for(r in i)n=i[r],e[r]&&kvm.isArray(e[r])?(kvm.isArray(n)||(n=[n]),o.push(e[r]=e[r].concat(n))):o.push(void 0);return o},$pop:function(e,t){var r,n,i,o;i=t.props,o=[];for(r in i)n=i[r],o.push(e[r]&&kvm.isArray(e[r])?e[r].pop():void 0);return o},$unshift:function(e,t){var r,n,i,o;i=t.props,o=[];for(r in i)n=i[r],o.push(e[r]&&kvm.isArray(e[r])?e[r].unshift(n):void 0);return o},$merge:function(e,t){return kvm.merge(e,t.props)},$deep_merge:function(e,t){return kvm.merge(!0,e,t.props)},$clone:function(e,r){var n,i,o,s,a,u;return s=!!r.clones.$deep,u=r.clones.$white_list,n=r.clones.$black_list,o=r.clones.$filter,i=r.commons.$callback,a=kvm.isEmpty(u)?kvm.isEmpty(n)?kvm.isFunction(o)?kvm.copy(s,e,function(e,t,r){var n;return kvm.isFunction(o)&&(n=o(e,t,r)),kvm.isBoolean(n)?n?!0:!1:!0}):kvm.copy(s,e):kvm.copy(s,e,function(e,r,i){var s;return t(i,n)?!1:(kvm.isFunction(o)&&(s=o(e,r,i)),kvm.isBoolean(s)?s?!0:!1:!0)}):kvm.copy(s,e,function(e,r,i){var s;return t(i,u,!0)?kvm.isEmpty(n)?!0:t(i,n)?!1:(kvm.isFunction(o)&&(s=o(e,r,i)),kvm.isBoolean(s)?s?!0:!1:!0):!1}),kvm.isFunction(i)?i(a):void 0},$find:function(e,t){function r(e,t){var r=!0;return e==t?r:(void 0==e||null==e?t&&(r=!t):r=e,r)}var n,i,o,s;return s=this,n=t.commons.$callback,i=Object.keys(t.filters).length,o=[],kvm.isEmpty(t.filters)?o=e:kvm.forEach(e,function(e){var n=0,a=r(t.filters.$and,t.filters.$or);kvm.isEmpty(e)||(kvm.forEach(t.filters,function(t,i){if("$or"==i||"$and"==i)return!0;var o=0,a=r(t.$and,t.$or);kvm.forEach(t,function(t,r){return"$or"==r||"$and"==r?!0:s.__parent__._filters[i](e[r],t)?a?o++:(o++,!1):void 0}),a?o>=kvm.getKeyLength(t)&&n++:o>0&&n++}),a?n>0&&o.push(e):n>=i&&o.push(e))}),kvm.isFunction(n)?n(o):void 0},$foreach:function(e,t){return kvm.isFunction(t.value)?kvm.forEach(e,t.value):void 0},$sort:function(e,t){var r,n,i,o;if(kvm.isArray(e)&&kvm.isReference(t.value)){i=t.props,o=[];for(r in i)n=i[r],o.push("desc"===n?e.sort(function(e,t){return kvm.isReference(e)&&kvm.isReference(t)?e[r]<t[r]?1:-1:t>e?1:-1}):e.sort(function(e,t){return kvm.isReference(e)&&kvm.isReference(t)?e[r]>t[r]?1:-1:e>t?1:-1}));return o}return e.sort("desc"===t.value?function(e,t){return t-e}:function(e,t){return e-t})}},_exec:function(e,t){var r,n,o;o=[];for(n in t)r=t[n],this._commands[n]?o.push(this._commands[n](e,this._collect(r))):kvm.isReference(r)&&!i[n]?(e[n]=e[n]||r.constructor(),o.push(this._exec(e[n],r))):o.push(void 0);return o},exec:function(e){return this._exec(this.data,e)}}),r.exec=function(t,n,i){return kvm.isFunction(i)&&e(n,function(e,t){var r;("$find"==t||"$clone"==t)&&(r=e.$callback||function(){},e.$callback=function(){var e=kvm.toArray(arguments);i.apply(null,e),r.apply(null,e)})}),new r(t,n)},r}),function(){kvm.module.registerPlugin(function(e){var t=kvm.module.data("baseUrl"),r=kvm.module.data("packages");e.registerPathParser(function(){var e,n,i=this.uri||this.id;i&&(n=i.indexOf("/"),e=i.substr(0,n),r&&r[e]&&(this.baseUrl=r[e].uri||r[e].url||t,this.uri=i.substr(n+1),this._parseVars()))})})}(),function(){kvm.module.registerPlugin(function(e){var t=kvm.module.data("shims");e.registerPathMaper(function(){var e=t[this.id];e&&(this.uri=e.uri||e.url,this._parser())}),e.registerDriverBeforeLoad(function(){var r=this.path,n=t[r.id];n&&n.exports&&!n.factory&&window[n.exports]&&(this.module=e.createModule(r.id,function(){return window[n.exports]}))}),e.registerDriverLoaded(function(){var e=this.path,r=t[e.id];r&&!e.getModule()&&(kvm.isFunction(r.factory)?kvm.module.define(e.id,r.factory):kvm.module.define(e.id,function(){return window[r.exports]}))})})}();