/**
 ** kvm.js - 一款兼容AMD,angular模块规范同时支持依赖注入的模块管理器
 ** @author Janry
 ** @version v0.1.0
 **/
!function(global){function _type(e){return Object.prototype.toString.call(e)}function isReference(e){return isArray(e)||isObject(e)}function isValue(e){return!isReference(e)}function isEmpty(e){if(null==e)return!0;if(e.length>0)return!1;if(0===e.length)return!0;for(var n in e)if(hasOwnProperty.call(e,n))return!1;return!0}function toArray(){var e;return e=[].slice.apply(arguments),[].slice.apply(e[0],e.slice(1))}function getKeyLength(e){return isArray(e)?e.length:isObject(e)?Object.keys(e).length:0}function unique(e){for(var n=0;n<e.length;++n)for(var t=n+1;t<e.length;++t)e[n]===e[t]&&e.splice(t--,1);return e}function bind(e,n){return function(){return isFunction(e)?e.apply(n,toArray(arguments)):void 0}}function forEach(e,n,t){var r,i,o,s;if(isFunction(n)){if(isReference(e)){for(i=Object.keys(e),o=i.length,r=0,s=[],0==o&&isFunction(t)&&t();o>r&&n(e[i[r]],i[r])!==!1;)s.push(r++);return s}isFunction(t)&&t()}}function guid(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}function eachTask(){var e,n,t,r=toArray(arguments),i=[];isArray(r[0])&&(e=r[0],2==r.length&&(t=r[1]),r.length>2&&(n=r[1],t=r[2]),function o(e,r){var s,c,u=e.length;u>r&&(s=function(){i=toArray(arguments),u>r+1?o(e,r+1):t.apply(null,i)},c=function(){i=toArray(arguments),isFunction(n)?(i.unshift(s),n.apply(null,i)):u>r+1?o(e,r+1):t.apply(null,i)},isFunction(e[r])?(i.unshift(c),e[r].apply(null,i)):isFunction(n)&&(i=[e[r],s],n.apply(null,i)))}(e,0))}function crawlObject(e,n,t){t=isBoolean(t)&&t===!1?!1:!0,isFunction(n)&&forEach(e,function(e,r){isReference(e)&&t?(n(e,r),crawlObject(e,n)):n(e,r)})}function merge(){var e,n,t,r=!1,i=!0;return e=toArray(arguments),isBoolean(e[0])&&(r=e[0],e=e.slice(1)),isFunction(e[e.length-1])&&(t=e[e.length-1],e.pop()),isBoolean(e[e.length-1])&&(i=e[e.length-1],e.pop()),n=e.length,2>n?e[0]:2===n?(forEach(e[1],function(n,o){isFunction(t)&&t(o,e[0],e[1]),void 0!==e[1][o]&&null!==e[1][o]&&(i?(e[0][o]=e[0][o]||e[1][o].constructor(),r&&isReference(n)?merge(r,e[0][o],n,i,t):e[0][o]=n):e[0][o]||(e[0][o]=e[0][o]||e[1][o].constructor(),r&&isReference(n)?merge(r,e[0][o],n,i,t):e[0][o]=n))}),e[0]):merge(r,e[0],merge.apply(null,[r].concat(e.slice(1))))}function copy(){var e,n,t,r,i,o;return e=toArray(arguments),t=!1,isBoolean(e[0])&&(t=e[0]===!0?!0:!1,e=e.slice(1)),isValue(e[0])?e[0]:(n=e[1]&&isFunction(e[1])?e[1]:!1,i=e[2]&&isString(e[2])?e[2]:"",r=isArray(e[0])?1:2,o=e[0].constructor(),forEach(e[0],function(e,s){var c,u;u=i?2===r?i+"."+s:i+"["+s+"]":s,n?(c=n(e,s,u),isBoolean(c)?c&&t&&isReference(e)?(o[s]=copy(t,e,n,u),u=i):o[s]=e:t&&isReference(e)?(o[s]=copy(t,e,n,u),u=i):o[s]=e):t&&isReference(e)?(o[s]=copy(t,e,n,u),u=i):o[s]=e}),o)}function inPaths(e,n,t){var r,i;return r=!1,i=function(e,n){var t,r,i;for(t=e.length,r=n.length,i=0;r>i;){if(n.charAt(i)!==e.charAt(i))return!1;i++}if(i===r){if(t===r)return!0;if(t>r&&"[.".indexOf(e.charAt(r))>-1)return!0}},forEach(n,function(n){return r=t?i(n,e):i(e,n),r?!1:void 0}),r}function Do(e,n){this.data=e,this._commands.__parent__=this,this._filters.__parent__=this,n&&this.exec(n)}function Class(e,n){return e&&e.constructor&&isFunction(e.constructor)&&e.constructor!==Object?(_class=function(){return e.constructor.apply(this,toArray(arguments))},_class.toString=function(){return e.constructor.toString()}):_class=function(){},merge(_class.prototype,e),merge(_class,n),_class}for(var TYPES="Function,String,Array,Object,Number,Boolean".split(","),hasOwnProperty=Object.prototype.hasOwnProperty,i=0;i<TYPES.length;i++)eval("function is"+TYPES[i]+'(val){return _type(val) === "[object '+TYPES[i]+']"};');var COMMANDS={OPERATORS:"$remove,$set,$push,$slice,$concat,$pop,$unshift,$merge,$deep_merge,$clone,$find,$sort,$foreach".split(","),FILTERS:"$gt,$lt,$is,$not,$gte,$lte,$icontains,$contains,$in,$not_in,$and,$or".split(","),SORTS:"$desc,$asc".split(","),CLONES:"$white_list,$black_list,$filter,$deep".split(","),COMMONS:"$callback".split(",")},KEYWORDS=function(){var e,n,t,r,i,o;t={};for(n in COMMANDS)for(o=COMMANDS[n],r=0,i=o.length;i>r;r++)e=o[r],t[e]=!0;return t}();merge(Do.prototype,{_collect:function(e){var n,t;if(t={operators:{},filters:{},sorts:{},clones:{},commons:{},props:{},value:null},!isReference(e))return t.value=e,t;for(n in e)COMMANDS.OPERATORS.indexOf(n)>-1?t.operators[n]=e[n]:COMMANDS.FILTERS.indexOf(n)>-1?t.filters[n]=e[n]:COMMANDS.SORTS.indexOf(n)>-1?t.sorts[n]=e[n]:COMMANDS.CLONES.indexOf(n)>-1?t.clones[n]=e[n]:COMMANDS.COMMONS.indexOf(n)>-1?t.commons[n]=e[n]:t.props[n]=e[n];return t},_filters:{$is:function(e,n){return e===n},$not:function(e,n){return e!==n},$gt:function(e,n){return e>n},$lt:function(e,n){return n>e},$gte:function(e,n){return e>=n},$lte:function(e,n){return n>=e},$icontains:function(e,n){return e.toLowerCase().indexOf(n.toLowerCase())>-1},$contains:function(e,n){return e.indexOf(n)>-1},$in:function(e,n){return n.indexOf(e)>-1},$not_in:function(e,n){return-1===n.indexOf(e)}},_commands:{$set:function(e,n){var t,r,i,o;i=n.props,o=[];for(t in i)r=i[t],isReference(r)?(e[t]=e[t]||r.constructor(),o.push(this.$set(e[t],this.__parent__._collect(r)))):o.push(e[t]=r);return o},$remove:function(e,n){var t,r,i,o;i=n.props,o=[];for(t in i)r=i[t],o.push(isArray(e)||r!==!0?void 0:delete e[t]);return o},$slice:function(e,n){var t,r,i,o;i=n.props,o=[];for(t in i)r=i[t],e[t]&&isArray(e[t])?(isArray(r)||(r=[r]),o.push(e[t]=e[t].slice.apply(e[t],r))):o.push(void 0);return o},$push:function(e,n){var t,r,i,o;i=n.props,o=[];for(t in i)r=i[t],o.push(e[t]&&isArray(e[t])?e[t].push(r):void 0);return o},$concat:function(e,n){var t,r,i,o;i=n.props,o=[];for(t in i)r=i[t],e[t]&&isArray(e[t])?(isArray(r)||(r=[r]),o.push(e[t]=e[t].concat(r))):o.push(void 0);return o},$pop:function(e,n){var t,r,i,o;i=n.props,o=[];for(t in i)r=i[t],o.push(e[t]&&isArray(e[t])?e[t].pop():void 0);return o},$unshift:function(e,n){var t,r,i,o;i=n.props,o=[];for(t in i)r=i[t],o.push(e[t]&&isArray(e[t])?e[t].unshift(r):void 0);return o},$merge:function(e,n){return merge(e,n.props)},$deep_merge:function(e,n){return merge(!0,e,n.props)},$clone:function(e,n){var t,r,i,o,s,c;return o=!!n.clones.$deep,c=n.clones.$white_list,t=n.clones.$black_list,i=n.clones.$filter,r=n.commons.$callback,s=isEmpty(c)?isEmpty(t)?isFunction(i)?copy(o,e,function(e,n,t){var r;return isFunction(i)&&(r=i(e,n,t)),isBoolean(r)?r?!0:!1:!0}):copy(o,e):copy(o,e,function(e,n,r){var o;return inPaths(r,t)?!1:(isFunction(i)&&(o=i(e,n,r)),isBoolean(o)?o?!0:!1:!0)}):copy(o,e,function(e,n,r){var o;return inPaths(r,c,!0)?isEmpty(t)?!0:inPaths(r,t)?!1:(isFunction(i)&&(o=i(e,n,r)),isBoolean(o)?o?!0:!1:!0):!1}),isFunction(r)?r(s):void 0},$find:function(e,n){function t(e,n){var t=!0;return e==n?t:(void 0==e||null==e?n&&(t=!n):t=e,t)}var r,i,o,s;return s=this,r=n.commons.$callback,i=Object.keys(n.filters).length,o=[],isEmpty(n.filters)?o=e:forEach(e,function(e){var r=0,c=t(n.filters.$and,n.filters.$or);isEmpty(e)||(forEach(n.filters,function(n,i){if("$or"==i||"$and"==i)return!0;var o=0,c=t(n.$and,n.$or);forEach(n,function(n,t){return"$or"==t||"$and"==t?!0:s.__parent__._filters[i](e[t],n)?c?o++:(o++,!1):void 0}),c?o>=getKeyLength(n)&&r++:o>0&&r++}),c?r>0&&o.push(e):r>=i&&o.push(e))}),isFunction(r)?r(o):void 0},$foreach:function(e,n){return isFunction(n.value)?forEach(e,n.value):void 0},$sort:function(e,n){var t,r,i,o;if(isArray(e)&&isReference(n.value)){i=n.props,o=[];for(t in i)r=i[t],o.push("desc"===r?e.sort(function(e,n){return isReference(e)&&isReference(n)?e[t]<n[t]?1:-1:n>e?1:-1}):e.sort(function(e,n){return isReference(e)&&isReference(n)?e[t]>n[t]?1:-1:e>n?1:-1}));return o}return e.sort("desc"===n.value?function(e,n){return n-e}:function(e,n){return e-n})}},_exec:function(e,n){var t,r,i;i=[];for(r in n)t=n[r],this._commands[r]?i.push(this._commands[r](e,this._collect(t))):isReference(t)&&!KEYWORDS[r]?(e[r]=e[r]||t.constructor(),i.push(this._exec(e[r],t))):i.push(void 0);return i},exec:function(e){return this._exec(this.data,e)}}),Do.exec=function(e,n,t){return isFunction(t)&&crawlObject(n,function(e,n){var r;("$find"==n||"$clone"==n)&&(r=e.$callback||function(){},e.$callback=function(){var e=toArray(arguments);t.apply(null,e),r.apply(null,e)})}),new Do(e,n)},Class.inherit=function(){function e(e,n){function t(){return e.apply(this,n)}return t.prototype=e.prototype,new t}function n(){var t=e(i,toArray(arguments));return merge(this,t,!1),this.$super=n,this.$parent&&isArray(this.$parent)?this.$parent.push(t):this.$parent=[t],t}var t=toArray(arguments);if(2==t.length){var r=t[0],i=t[1];isFunction(r)&&isFunction(i)&&(merge(r.prototype,i.prototype,!1,function(e,n,t){if(t.$$isprotocol===!0&&isFunction(t[e])&&!isFunction(n[e]))throw"The subclass does not follow protocol"}),r.prototype.$super=n,r.prototype.$parent=i.prototype,r.prototype.constructor=r)}else if(t.length>2)for(var o=1;o<t.length;o++)Class.inherit(t[0],t[o])},Class.protocol=function(e){return e.$$isprotocol=!0,Class(e)};var Emitter=Class({constructor:function(e){this.__$$events__=e?e:{}},$on:function(e,n){var t=this;return e=e.split(","),forEach(e,function(e){isFunction(n)&&(t.__$$events__[e]&&isArray(t.__$$events__[e])?t.__$$events__[e].push(n):t.__$$events__[e]=[n])}),this},$emit:function(e){var n=toArray(arguments),t=0,r=this.__$$events__[e];if(r&&isArray(r))for(t;t<r.length;t++)r[t].apply(null,n.slice(1));return this},$remove:function(e,n){var t=this.__$$events__[e];if(t&&isArray(t))if(n)for(var r=t.length-1;r>=0;r--)n===t[r]&&t.splice(r,1);else delete this.__$$events__[e];return this}}),Loader=function(){var e={},n=Class({constructor:function(n,r){function i(e){return o.results.push(e),o._checkDone()?(r(o.results),o._destroy(),!1):void 0}var o=this,s=Injector.data("shims");o.req_list=n,o.loaders=[],o.results=[],forEach(n,function(n){var r,c,u=Injector.resolve(n);if(e[u]&&(r=e[u]),!r&&!(c=ModuleDB.get(n,u))){if(s[n])try{if(isFunction(s[n].checkConflict)){if(s[n].checkConflict()===!1)throw new Error("fake error")}else{if(s[n].factory||!s[n].exports)throw new Error("fake error");if(s[n].factory=function(){return global[s[n].exports]},!global[s[n].exports])throw new Error("fake error")}return i(Injector.define(n,s[n].factory))}catch(a){r=new t(n,u,function(){Injector.define(n,s[n].factory)})}else r=new t(n,u);r&&(e[r.uri]=r)}if(c)return i(c);if(r){if(r.module)return i(r.module);o.loaders.push(r),r.$on("loaded",function(e){return r.module=e,i(e)})}}),forEach(o.loaders,function(e){e.load()})},_destroy:function(){delete this.results,delete this.loaders,delete this.req_list},_checkDone:function(){return this.req_list.length==this.results.length}}),t=Class({constructor:function(e,n,t){this.id=e,this.uri=n,this.callback=t,this.module=null,this.$super()},load:function(){this._load(this.uri,this.callback)},_load:function(e,n){function t(e,n){function t(t){e.onload=e.onerror=e.onreadystatechange=null,Injector.data("debug")||i.removeChild(e),e=null,n&&n(t)}var r="onload"in e;r?(e.onload=t,e.onerror=function(){t(!0)}):e.onreadystatechange=function(){/loaded|complete/.test(e.readyState)&&t()}}var r=document,i=r.head||r.getElementsByTagName("head")[0]||r.documentElement,o=i.getElementsByTagName("base")[0],s=r.createElement("script");s.async=!0,s.src=e,t(s,n),o?i.insertBefore(s,o):i.appendChild(s)}});return Class.inherit(t,Emitter),Class({constructor:function(e){this.module=e},setModule:function(e){this.module=e},fetchDeps:function(e){var n=[],t=this;forEach(this.module.dep_ids,function(e){t.module.injectors&&t.module.injectors[e]||n.push(e)}),Loader.fetchList(n,e)},fetch:function(e){Loader.fetchList([this.module.id],function(n){n&&n.length>0&&isFunction(e)&&e(n[0])})}},{getLoader:function(n,t,r){var t=t||Injector.resolve(n);if(!t)throw new Error("资源未标识");e[t]&&r(e[t])},fetchList:function(){var e=[],t=toArray(arguments),r=t[t.length-1];isFunction(r)&&(t=t.slice(0,t.length-1),forEach(t,function(n){isArray(n)?e=e.concat(n):e.push(n)}),new n(e,r))}})}(),Module=Class({constructor:function(e){merge(this,{id:"",uri:"",dep_ids:[],factory:null,injectors:{},installed:!1,module:{exports:{}}},e),this.$super(),this.injectExports(),this.collectDeps()},injectExports:function(){var e=this;this.injectors.exports=function(){return e.module.exports},this.injectors.module=function(){return e.module},this.injectors.require=function(){return function(e){var n=Injector.resolve(e),t=ModuleDB.get(e,n);return t.module.exports}}},collectDeps:function(){isFunction(this.factory)&&(this.dep_ids=unique(this.dep_ids.concat(this.parseDependencies(this.factory.toString()))))},parseDependencies:function(e){function n(){l=e.charAt(f++)}function t(){return/\s/.test(l)}function r(){return'"'==l||"'"==l}function i(){var t=f,r=l,i=e.indexOf(r,t);if(-1==i)f=h;else if("\\"!=e.charAt(i-1))f=i+1;else for(;h>f;)if(n(),"\\"==l)f++;else if(l==r)break;d&&(v.push(e.slice(t,f-1)),d=0)}function o(){for(f--;h>f;)if(n(),"\\"==l)f++;else{if("/"==l)break;if("["==l)for(;h>f;)if(n(),"\\"==l)f++;else if("]"==l)break}}function s(){return/[a-z_$]/i.test(l)}function c(){var n=e.slice(f-1),t=/^[\w$]+/.exec(n)[0];g={"if":1,"for":1,"while":1,"with":1}[t],p={"break":1,"case":1,"continue":1,"debugger":1,"delete":1,"do":1,"else":1,"false":1,"if":1,"in":1,"instanceof":1,"return":1,"typeof":1,"void":1}[t],d=/^require\s*\(\s*(['"]).+?\1\s*\)/.test(n),d?(t=/^require\s*\(\s*['"]/.exec(n)[0],f+=t.length-2):f+=/^[\w$]+(?:\s*\.\s*[\w$]+)*/.exec(n)[0].length-1}function u(){return/\d/.test(l)||"."==l&&/\d/.test(e.charAt(f))}function a(){var n,t=e.slice(f-1);n="."==l?/^\.\d+(?:E[+-]?\d*)?\s*/i.exec(t)[0]:/^0x[\da-f]*/i.test(t)?/^0x[\da-f]*\s*/i.exec(t)[0]:/^\d+\.?\d*(?:E[+-]?\d*)?\s*/i.exec(t)[0],f+=n.length-1,p=0}if(-1==e.indexOf("require"))return[];for(var l,f=0,h=e.length,p=1,d=0,g=0,m=[],v=[];h>f;)n(),t()||(r()?(i(),p=1):"/"==l?(n(),"/"==l?(f=e.indexOf("\n",f),-1==f&&(f=e.length)):"*"==l?(f=e.indexOf("*/",f),-1==f?f=h:f+=2):p?(o(),p=0):(f--,p=1)):s()?c():u()?a():"("==l?(m.push(g),p=1):")"==l?p=m.pop():(p="]"!=l,d=0));return v}});Class.inherit(Module,Emitter);var ModuleDB=function(){var e={};return{add:function(n){return this.get(n.id,n.uri)||(e[n.id||n.uri]=n,Loader.getLoader(n.id,n.uri,function(e){e.$emit("loaded",n)})),this},get:function(n,t){return e[n]||e[t]}}}(),Injector=function(){function e(){var e=document,n=e.head||e.getElementsByTagName("head")[0]||e.documentElement;if(e.currentScript)return e.currentScript.src;var t;try{a.b.c()}catch(r){t=r.stack,!t&&window.opera&&(t=(String(r).match(/of linked script \S+/g)||[]).join(" "))}if(t)return t=t.split(/[@ ]/g).pop(),t="("==t[0]?t.slice(1,-1):t,t.replace(/(:\d+)?:\d+$/i,"");for(var i,o=n.getElementsByTagName("script"),s=0;i=o[s++];)if("interactive"===i.readyState)return i.className=i.src}function n(e,n){return t(e,n.replace(/\.js/,""))+".js"}function t(){var e=arguments.length;if(0===e)throw new Error("resolveUrl requires at least one argument; got none.");var n=document.createElement("base");if(n.href=arguments[0],1===e)return n.href;var t=document.getElementsByTagName("head")[0];t.insertBefore(n,t.firstChild);for(var r,i=document.createElement("a"),o=1;e>o;o++)i.href=arguments[o],r=i.href,n.href=r;return t.removeChild(n),r}function r(e){return isFunction(e)||isArray(e)&&isFunction(e[e.length-1])}function i(e){var n=!0;return isArray(e)?(forEach(e,function(e){return isString(e)?void 0:n=!1}),n):!1}function o(){var n,t=toArray(arguments),o="",s="",c=[],u={},a=!0;return isBoolean(t[0])?(a=t[0],t=t.slice(1,4)):t=t.slice(0,3),forEach(t,function(e){r(e)?isFunction(e)?n=e:(n=e[e.length-1],c=e.slice(0,e.length-1)):i(e)?c=e:isString(e)?(o=e,s=Injector.resolve(o)):isObject(e)&&(u=e)}),!s&&a&&(s=e()),new Module({uri:s,id:o,dep_ids:c,factory:n,injectors:u})}function s(e,n,t){function r(t,r){var s;r&&(i[t]=r,o++),o==n.dep_ids.length&&(n.installed?s=n.module.exports:(-1!=n.dep_ids.indexOf("module")||-1!=n.dep_ids.indexOf("exports")?(n.factory.apply(null,i),s=n.module.exports):s=n.module.exports=n.factory.apply(null,i)||{},n.installed=!0),e(s))}var i=[],o=0;forEach(n.dep_ids,function(e,i){n.injectors&&n.injectors[e]?Injector.invoke(n.injectors[e]).then(function(e){r(i,e)})["catch"](function(e){throw e}):forEach(t,function(n){(n.id&&n.id==e||n.uri&&n.uri==Injector.resolve(e))&&(n.installed&&r(i,n.module.exports),Injector.invoke(e).then(function(e){r(i,e)})["catch"](function(e){throw e}))})},function(){r()})}function c(e){if(!isString(e))throw new Error("路径类型错误");var n,t=/\{([^{}]+)\}/g;return n=e.replace(t,function(e,n){return h.vars[n]?h.vars[n]:n}),t.test(n)?c(n):n}function u(e){return e.replace(/\/$/,"")+"/"}function l(e){return e=h.shims[e]?h.shims[e].url||h.shims[e].uri:h.alias[e]?h.alias[e]:e,e=c(e),e=h.shims[e]?h.shims[e].url||h.shims[e].uri:e}function f(e){var n,t;return t=e.indexOf("/"),n=e.substr(0,t),h.packages&&h.packages[n]?{name:u(h.packages[n].url||h.packages[n].uri||""),path:e.substr(t+1)}:{name:"",path:e}}var h={baseUrl:window.location.href,shims:{},vars:{},packages:{},alias:{}};return{config:function(e){merge(h,e)},resolve:function(e){var t;return e=l(e),t=f(e),n(t.name||h.baseUrl,t.path)},data:function(e){return e?h[e]:h},define:function(){var e=o.apply(null,toArray(arguments));if(!e.uri||!e.factory)throw new Error("模块定义不规范");return ModuleDB.add(e),e},invoke:function(){var e,n=o.apply(null,toArray(arguments));return e=new Loader(n),new Promise(function(t){if(n.id&&!n.factory)e.fetch(function(r){r=merge(n,r),e.setModule(r),r.dep_ids.length>0?e.fetchDeps(function(e){s(t,r,e)}):s(t,r,[])});else{if(n.id||!n.factory)throw new Error("模块调用不符合规范");n.dep_ids.length>0?e.fetchDeps(function(e){s(t,n,e)}):s(t,n,[])}})},use:function(e,n){this.invoke(e).then(n)["catch"](function(e){throw e})}}}();Injector.define("$do",function(){return Do}),Injector.define("$dataOperator",function(){return Do}),Injector.define("$class",function(){return Class}),Injector.define("$emitter",function(){return Emitter}),global.kvm={},merge(global.kvm,{isArray:isArray,isString:isString,isFunction:isFunction,isObject:isObject,isReference:isReference,isEmpty:isEmpty,isBoolean:isBoolean,getKeyLength:getKeyLength,isValue:isValue,guid:guid,unique:unique,toArray:toArray,bind:bind,forEach:forEach,merge:merge,eachTask:eachTask,copy:copy}),global.KVM=global.kvm,global.kvm.module=Injector,global.KVM.Module=Injector,global.define=Injector.define,global.define.amd=!0}(window);