/**
 ** kvm.js - 一款兼容AMD,angular模块规范同时支持依赖注入的模块管理器
 ** @author Janry
 ** @version v0.0.3
 **/
!function(global){function _type(n){return Object.prototype.toString.call(n)}function isReference(n){return isArray(n)||isObject(n)}function isValue(n){return!isReference(n)}function isEmpty(n){if(null==n)return!0;if(n.length>0)return!1;if(0===n.length)return!0;for(var t in n)if(hasOwnProperty.call(n,t))return!1;return!0}function toArray(){var n;return n=[].slice.apply(arguments),[].slice.apply(n[0],n.slice(1))}function getKeyLength(n){return isArray(n)?n.length:isObject(n)?Object.keys(n).length:0}function unique(n){for(var t=0;t<n.length;++t)for(var e=t+1;e<n.length;++e)n[t]===n[e]&&n.splice(e--,1);return n}function bind(n,t){return function(){return isFunction(n)?n.apply(t,toArray(arguments)):void 0}}function forEach(n,t,e){var r,o,i,s;if(isFunction(t)){if(isReference(n)){for(o=Object.keys(n),i=o.length,r=0,s=[],0==i&&isFunction(e)&&e();i>r&&t(n[o[r]],o[r])!==!1;)s.push(r++);return s}isFunction(e)&&e()}}function guid(){function n(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()}function eachTask(){var n,t,e,r=toArray(arguments),o=[];isArray(r[0])&&(n=r[0],2==r.length&&(e=r[1]),r.length>2&&(t=r[1],e=r[2]),function i(n,r){var s,c,u=n.length;u>r&&(s=function(){o=toArray(arguments),u>r+1?i(n,r+1):e.apply(null,o)},c=function(){o=toArray(arguments),isFunction(t)?(o.unshift(s),t.apply(null,o)):u>r+1?i(n,r+1):e.apply(null,o)},isFunction(n[r])?(o.unshift(c),n[r].apply(null,o)):isFunction(t)&&(o=[n[r],s],t.apply(null,o)))}(n,0))}function crawlObject(n,t,e){e=isBoolean(e)&&e===!1?!1:!0,isFunction(t)&&forEach(n,function(n,r){isReference(n)&&e?(t(n,r),crawlObject(n,t)):t(n,r)})}function merge(){var n,t,e,r=!1,o=!0;return n=toArray(arguments),isBoolean(n[0])&&(r=n[0],n=n.slice(1)),isFunction(n[n.length-1])&&(e=n[n.length-1],n.pop()),isBoolean(n[n.length-1])&&(o=n[n.length-1],n.pop()),t=n.length,2>t?n[0]:2===t?(forEach(n[1],function(t,i){isFunction(e)&&e(i,n[0],n[1]),void 0!==n[1][i]&&null!==n[1][i]&&(o?(n[0][i]=n[0][i]||n[1][i].constructor(),r&&isReference(t)?merge(r,n[0][i],t,o,e):n[0][i]=t):n[0][i]||(n[0][i]=n[0][i]||n[1][i].constructor(),r&&isReference(t)?merge(r,n[0][i],t,o,e):n[0][i]=t))}),n[0]):merge(r,n[0],merge.apply(null,[r].concat(n.slice(1))))}function copy(){var n,t,e,r,o,i;return n=toArray(arguments),e=!1,isBoolean(n[0])&&(e=n[0]===!0?!0:!1,n=n.slice(1)),isValue(n[0])?n[0]:(t=n[1]&&isFunction(n[1])?n[1]:!1,o=n[2]&&isString(n[2])?n[2]:"",r=isArray(n[0])?1:2,i=n[0].constructor(),forEach(n[0],function(n,s){var c,u;u=o?2===r?o+"."+s:o+"["+s+"]":s,t?(c=t(n,s,u),isBoolean(c)?c&&e&&isReference(n)?(i[s]=copy(e,n,t,u),u=o):i[s]=n:e&&isReference(n)?(i[s]=copy(e,n,t,u),u=o):i[s]=n):e&&isReference(n)?(i[s]=copy(e,n,t,u),u=o):i[s]=n}),i)}function Class(n,t){return n&&n.constructor&&isFunction(n.constructor)&&n.constructor!==Object?(_class=function(){return n.constructor.apply(this,toArray(arguments))},_class.toString=function(){return n.constructor.toString()}):_class=function(){},merge(_class.prototype,n),merge(_class,t),_class}function Do(n,t){this.data=n,this._commands.__parent__=this,this._filters.__parent__=this,t&&this.exec(t)}function Class(n,t){var e;return n&&n.constructor&&isFunction(n.constructor)?(e=function(){return n.constructor.apply(this,toArray(arguments))},e.toString=function(){return n.constructor.toString()}):e=function(){},merge(e.prototype,n),merge(e,t),e}for(var TYPES="Function,String,Array,Object,Number,Boolean".split(","),hasOwnProperty=Object.prototype.hasOwnProperty,i=0;i<TYPES.length;i++)eval("function is"+TYPES[i]+'(val){return _type(val) === "[object '+TYPES[i]+']"};');Class.inherit=function(){function n(n,t){function e(){return n.apply(this,t)}return e.prototype=n.prototype,new e}function t(){var e=n(o,toArray(arguments));return merge(this,e,!1),this.$super=t,this.$parent&&isArray(this.$parent)?this.$parent.push(e):this.$parent=[e],e}var e=toArray(arguments);if(2==e.length){var r=e[0],o=e[1];isFunction(r)&&isFunction(o)&&(merge(r.prototype,o.prototype,!1,function(n,t,e){if(e.$$isprotocol===!0&&isFunction(e[n])&&!isFunction(t[n]))throw"The subclass does not follow protocol"}),r.prototype.$super=t,r.prototype.$parent=o.prototype,r.prototype.constructor=r)}else if(e.length>2)for(var i=1;i<e.length;i++)Class.inherit(e[0],e[i])},Class.protocol=function(n){return n.$$isprotocol=!0,Class(n)};var Emitter=Class({constructor:function(n){this.__$$events__=n?n:{}},$on:function(n,t){var e=this;return n=n.split(","),forEach(n,function(n){isFunction(t)&&(e.__$$events__[n]&&isArray(e.__$$events__[n])?e.__$$events__[n].push(t):e.__$$events__[n]=[t])}),this},$emit:function(n){var t=toArray(arguments),e=0,r=this.__$$events__[n];if(r&&isArray(r))for(e;e<r.length;e++)r[e].apply(null,t.slice(1));return this},$remove:function(n,t){var e=this.__$$events__[n];if(e&&isArray(e))if(t)for(var r=e.length-1;r>=0;r--)t===e[r]&&e.splice(r,1);else delete this.__$$events__[n];return this}}),COMMANDS={OPERATORS:"$remove,$set,$push,$slice,$concat,$pop,$unshift,$merge,$deep_merge,$clone,$find,$sort,$foreach".split(","),FILTERS:"$gt,$lt,$is,$not,$gte,$lte,$icontains,$contains,$in,$not_in,$and,$or".split(","),SORTS:"$desc,$asc".split(","),CLONES:"$white_list,$black_list,$filter,$deep".split(","),COMMONS:"$callback".split(",")},KEYWORDS=function(){var n,t,e,r,o,i;e={};for(t in COMMANDS)for(i=COMMANDS[t],r=0,o=i.length;o>r;r++)n=i[r],e[n]=!0;return e}();merge(Do.prototype,{_collect:function(n){var t,e;if(e={operators:{},filters:{},sorts:{},clones:{},commons:{},props:{},value:null},!isReference(n))return e.value=n,e;for(t in n)COMMANDS.OPERATORS.indexOf(t)>-1?e.operators[t]=n[t]:COMMANDS.FILTERS.indexOf(t)>-1?e.filters[t]=n[t]:COMMANDS.SORTS.indexOf(t)>-1?e.sorts[t]=n[t]:COMMANDS.CLONES.indexOf(t)>-1?e.clones[t]=n[t]:COMMANDS.COMMONS.indexOf(t)>-1?e.commons[t]=n[t]:e.props[t]=n[t];return e},_filters:{$is:function(n,t){return n===t},$not:function(n,t){return n!==t},$gt:function(n,t){return n>t},$lt:function(n,t){return t>n},$gte:function(n,t){return n>=t},$lte:function(n,t){return t>=n},$icontains:function(n,t){return n.toLowerCase().indexOf(t.toLowerCase())>-1},$contains:function(n,t){return n.indexOf(t)>-1},$in:function(n,t){return t.indexOf(n)>-1},$not_in:function(n,t){return-1===t.indexOf(n)}},_commands:{$set:function(n,t){var e,r,o,i;o=t.props,i=[];for(e in o)r=o[e],isReference(r)?(n[e]=n[e]||r.constructor(),i.push(this.$set(n[e],this.__parent__._collect(r)))):i.push(n[e]=r);return i},$remove:function(n,t){var e,r,o,i;o=t.props,i=[];for(e in o)r=o[e],i.push(isArray(n)||r!==!0?void 0:delete n[e]);return i},$slice:function(n,t){var e,r,o,i;o=t.props,i=[];for(e in o)r=o[e],n[e]&&isArray(n[e])?(isArray(r)||(r=[r]),i.push(n[e]=n[e].slice.apply(n[e],r))):i.push(void 0);return i},$push:function(n,t){var e,r,o,i;o=t.props,i=[];for(e in o)r=o[e],i.push(n[e]&&isArray(n[e])?n[e].push(r):void 0);return i},$concat:function(n,t){var e,r,o,i;o=t.props,i=[];for(e in o)r=o[e],n[e]&&isArray(n[e])?(isArray(r)||(r=[r]),i.push(n[e]=n[e].concat(r))):i.push(void 0);return i},$pop:function(n,t){var e,r,o,i;o=t.props,i=[];for(e in o)r=o[e],i.push(n[e]&&isArray(n[e])?n[e].pop():void 0);return i},$unshift:function(n,t){var e,r,o,i;o=t.props,i=[];for(e in o)r=o[e],i.push(n[e]&&isArray(n[e])?n[e].unshift(r):void 0);return i},$merge:function(n,t){return merge(n,t.props)},$deep_merge:function(n,t){return merge(!0,n,t.props)},$clone:function(n,t){var e,r,o,i,s,c;return i=!!t.clones.$deep,c=t.clones.$white_list,e=t.clones.$black_list,o=t.clones.$filter,r=t.commons.$callback,s=isEmpty(c)?isEmpty(e)?isFunction(o)?copy(i,n,function(n,t,e){var r;return isFunction(o)&&(r=o(n,t,e)),isBoolean(r)?r?!0:!1:!0}):copy(i,n):copy(i,n,function(n,t,r){var i;return inPaths(r,e)?!1:(isFunction(o)&&(i=o(n,t,r)),isBoolean(i)?i?!0:!1:!0)}):copy(i,n,function(n,t,r){var i;return inPaths(r,c,!0)?isEmpty(e)?!0:inPaths(r,e)?!1:(isFunction(o)&&(i=o(n,t,r)),isBoolean(i)?i?!0:!1:!0):!1}),isFunction(r)?r(s):void 0},$find:function(n,t){function e(n,t){var e=!0;return n==t?e:(void 0==n||null==n?t&&(e=!t):e=n,e)}var r,o,i,s;return s=this,r=t.commons.$callback,o=Object.keys(t.filters).length,i=[],isEmpty(t.filters)?i=n:forEach(n,function(n){var r=0,c=e(t.filters.$and,t.filters.$or);isEmpty(n)||(forEach(t.filters,function(t,o){if("$or"==o||"$and"==o)return!0;var i=0,c=e(t.$and,t.$or);forEach(t,function(t,e){return"$or"==e||"$and"==e?!0:s.__parent__._filters[o](n[e],t)?c?i++:(i++,!1):void 0}),c?i>=getKeyLength(t)&&r++:i>0&&r++}),c?r>0&&i.push(n):r>=o&&i.push(n))}),isFunction(r)?r(i):void 0},$foreach:function(n,t){return isFunction(t.value)?forEach(n,t.value):void 0},$sort:function(n,t){var e,r,o,i;if(isArray(n)&&isReference(t.value)){o=t.props,i=[];for(e in o)r=o[e],i.push("desc"===r?n.sort(function(n,t){return isReference(n)&&isReference(t)?n[e]<t[e]?1:-1:t>n?1:-1}):n.sort(function(n,t){return isReference(n)&&isReference(t)?n[e]>t[e]?1:-1:n>t?1:-1}));return i}return n.sort("desc"===t.value?function(n,t){return t-n}:function(n,t){return n-t})}},_exec:function(n,t){var e,r,o;o=[];for(r in t)e=t[r],this._commands[r]?o.push(this._commands[r](n,this._collect(e))):isReference(e)&&!KEYWORDS[r]?(n[r]=n[r]||e.constructor(),o.push(this._exec(n[r],e))):o.push(void 0);return o},exec:function(n){return this._exec(this.data,n)}}),Do.exec=function(n,t,e){return isFunction(e)&&crawlObject(t,function(n,t){var r;("$find"==t||"$clone"==t)&&(r=n.$callback||function(){},n.$callback=function(){var n=toArray(arguments);e.apply(null,n),r.apply(null,n)})}),new Do(n,t)},Class.inherit=function(){function n(n,t){function e(){return n.apply(this,t)}return e.prototype=n.prototype,new e}function t(){var e=n(o,toArray(arguments));return merge(this,e,!1),this.$super=t,this.$parent&&isArray(this.$parent)?this.$parent.push(e):this.$parent=[e],e}var e=toArray(arguments);if(2==e.length){var r=e[0],o=e[1];isFunction(r)&&isFunction(o)&&(merge(r.prototype,o.prototype,!1,function(n,t,e){if(e.$$isprotocol===!0&&isFunction(e[n])&&!isFunction(t[n]))throw"The subclass does not follow protocol"}),r.prototype.$super=t,r.prototype.$parent=o.prototype,r.prototype.constructor=r)}else if(e.length>2)for(var i=1;i<e.length;i++)Class.inherit(e[0],e[i])},Class.protocol=function(n){return n.$$isprotocol=!0,Class(n)};var Emitter=Class({constructor:function(n){this.__$$events__=n?n:{}},$on:function(n,t){var e=this;return n=n.split(","),forEach(n,function(n){isFunction(t)&&(e.__$$events__[n]&&isArray(e.__$$events__[n])?e.__$$events__[n].push(t):e.__$$events__[n]=[t])}),this},$emit:function(n){var t=toArray(arguments),e=0,r=this.__$$events__[n];if(r&&isArray(r))for(e;e<r.length;e++)r[e].apply(null,t.slice(1));return this},$remove:function(n,t){var e=this.__$$events__[n];if(e&&isArray(e))if(t)for(var r=e.length-1;r>=0;r--)t===e[r]&&e.splice(r,1);else delete this.__$$events__[n];return this}}),Loader=function(){var n=[],t=Class({constructor:function(t,r){var o=this,i=Injector.data("shims");o.req_list=t,o.loaders=[],o.results=[],forEach(t,function(t){var s,c,u=Injector.resolve(t);if(forEach(n,function(n){return n.uri==u?(s=n,!1):void 0}),s||(s=new e(t,u,function(){i[t]&&Injector.define(t,i[t].factory)}),n.push(s)),s.module){if(o.results.push(s.module),o._checkDone())return r(o.results),!1}else if(c=ModuleDB.get(t,u)){if(o.results.push(c),o._checkDone())return r(o.results),!1}else o.loaders.push(s),s.$on("loaded",function(n){return s.module=n,o.results.push(n),o._checkDone()?(r(o.results),!1):void 0})}),forEach(o.loaders,function(n){n.load()})},_checkDone:function(){return this.req_list.length==this.results.length}}),e=Class({constructor:function(n,t,e){var r=this;this.id=n,this.uri=t,this.callback=e,this.state="pendding",this.module=null,this.$super(),this.$on("loaded",function(){r.state="done"})},load:function(){this._load(this.uri,this.callback)},_load:function(n,t){function e(n,t){function e(e){n.onload=n.onerror=n.onreadystatechange=null,Injector.debug||o.removeChild(n),n=null,t&&t(e)}var r="onload"in n;r?(n.onload=e,n.onerror=function(){e(!0)}):n.onreadystatechange=function(){/loaded|complete/.test(n.readyState)&&e()}}var r=document,o=r.head||r.getElementsByTagName("head")[0]||r.documentElement,i=o.getElementsByTagName("base")[0],s=r.createElement("script");s.async=!0,s.src=n,e(s,t),i?o.insertBefore(s,i):o.appendChild(s)}});return Class.inherit(e,Emitter),Class({constructor:function(n){this.module=n},setModule:function(n){this.module=n},fetchDeps:function(n){var t=[],e=this;forEach(this.module.dep_ids,function(n){e.module.injectors&&e.module.injectors[n]||t.push(n)}),Loader.fetchList(t,n)},fetch:function(n){Loader.fetchList([this.module.id],function(t){t&&t.length>0&&isFunction(n)&&n(t[0])})}},{getLoader:function(t,e,r){var e=e||Injector.resolve(t);if(!e)throw new Error("资源未标识");forEach(n,function(n){return n.uri&&n.uri==e||n.id&&n.id==t?(r(n),!1):void 0})},fetchList:function(){var n=[],e=toArray(arguments),r=e[e.length-1];isFunction(r)&&(e=e.slice(0,e.length-1),forEach(e,function(t){isArray(t)?n=n.concat(t):n.push(t)}),new t(n,r))}})}(),Module=Class({constructor:function(n){merge(this,{id:"",uri:"",dep_ids:[],factory:null,injectors:null},n),this.$super(),this.register()},register:function(){var n=this;this.$on("loaded",function(){n.loaded=!0}),this.$on("invoked",function(){n.invoked=!0})}}),ModuleDB=function(){var n=[];return Class.inherit(Module,Emitter),{add:function(t){var e=new Module(t);return this.get(t.id,t.uri)||(n.push(e),e.$emit("loaded"),Loader.getLoader(t.id,t.uri,function(n){n.$emit("loaded",e)})),this},get:function(t,e){var r;return forEach(n,function(n){return n.id&&t&&n.id==t||n.uri&&e&&n.uri==e?(r=n,!1):void 0}),r}}}(),Injector=function(){function n(){var n=document,t=n.head||n.getElementsByTagName("head")[0]||n.documentElement;if(n.currentScript)return n.currentScript.src;var e;try{a.b.c()}catch(r){e=r.stack,!e&&window.opera&&(e=(String(r).match(/of linked script \S+/g)||[]).join(" "))}if(e)return e=e.split(/[@ ]/g).pop(),e="("==e[0]?e.slice(1,-1):e,e.replace(/(:\d+)?:\d+$/i,"");for(var o,i=t.getElementsByTagName("script"),s=0;o=i[s++];)if("interactive"===o.readyState)return o.className=o.src}function t(n,t){return e(t)?t:r(t)?o(n,t)+".js":t}function e(n){return/^https?:|^file:|^\/|\.js$/.test(n)}function r(n){return 0===(n+"").indexOf(".")}function o(){var n=arguments.length;if(0===n)throw new Error("resolveUrl requires at least one argument; got none.");var t=document.createElement("base");if(t.href=arguments[0],1===n)return t.href;var e=document.getElementsByTagName("head")[0];e.insertBefore(t,e.firstChild);for(var r,o=document.createElement("a"),i=1;n>i;i++)o.href=arguments[i],r=o.href,t.href=r;return e.removeChild(t),r}function i(n){return isFunction(n)||isArray(n)&&isFunction(n[n.length-1])}function s(n){var t=!0;return isArray(n)?(forEach(n,function(n){return isString(n)?void 0:t=!1}),t):!1}function c(){var t,e=toArray(arguments),r="",o="",c=[],u=null,a=!0;return isBoolean(e[0])?(a=e[0],e=e.slice(1,4)):e=e.slice(0,3),forEach(e,function(n){i(n)?isFunction(n)?t=n:(t=n[n.length-1],c=n.slice(0,n.length-1)):s(n)?c=n:isString(n)?(r=n,o=Injector.resolve(r)):isObject(n)&&(u=n)}),!o&&a&&(o=n()),new Module({uri:o,id:r,dep_ids:c,factory:t,injectors:u})}function u(n,t,e,r){function o(e,o){var c;o&&(i[e]=o,s++),s==t.dep_ids.length&&(c=r?t.instance?t.instance:t.instance=t.factory.apply(null,i):t.factory.apply(null,i),t.$emit("invoked"),n(c))}var i=[],s=0;r=isBoolean(r)?r:!1,forEach(t.dep_ids,function(n,i){t.injectors&&t.injectors[n]?Injector.invoke(t.injectors[n]).then(function(n){o(i,n)})["catch"](function(n){throw n}):forEach(e,function(t){(t.id&&t.id==n||t.uri&&t.uri==Injector.resolve(n))&&(t.instance&&r&&o(i,t.instance),Injector.invoke(n).then(function(n){o(i,n)})["catch"](function(n){throw n}))})},function(){o()})}function l(n){if(!isString(n))throw new Error("路径类型错误");var t,e=/\{([^{}]+)\}/g;return t=n.replace(e,function(n,t){return f.vars[t]?f.vars[t]:t}),e.test(t)?tmp(t):t}var f={baseUrl:window.location.href,shims:{},vars:{},alias:{}};return{config:function(n){merge(f,n)},resolve:function(n){return n=l(f.shims[n]?f.shims[n].url||f.shims[n].uri:f.alias[n]?f.alias[n]:n),t(f.baseUrl,n)},data:function(n){return n?f[n]:f},define:function(){var n=c.apply(null,toArray(arguments));if(!n.uri||!n.factory)throw new Error("模块定义不规范");ModuleDB.add(n)},invoke:function(){var n,t,e=toArray(arguments);return e.unshift(!1),n=c.apply(null,e),t=new Loader(n),new Promise(function(e){if(n.id&&!n.factory)t.fetch(function(r){r=merge(n,r),t.setModule(r),r.dep_ids.length>0?t.fetchDeps(function(n){u(e,r,n,!0)}):u(e,r,[])});else{if(n.id||!n.factory)throw new Error("模块调用不符合规范");n.dep_ids.length>0?t.fetchDeps(function(t){u(e,n,t)}):u(e,n,[])}})},use:function(n,t){this.invoke(n).then(t)["catch"](function(n){throw n})}}}();Injector.define("$do",function(){return Do}),Injector.define("$dataOperator",function(){return Do}),Injector.define("$class",function(){return Class}),Injector.define("$emitter",function(){return Emitter}),global.kvm={},merge(global.kvm,{isArray:isArray,isString:isString,isFunction:isFunction,isObject:isObject,isReference:isReference,isEmpty:isEmpty,isBoolean:isBoolean,getKeyLength:getKeyLength,isValue:isValue,guid:guid,unique:unique,toArray:toArray,bind:bind,forEach:forEach,merge:merge,eachTask:eachTask,copy:copy}),global.KVM=global.kvm,global.kvm.module=Injector,global.KVM.Module=Injector,global.define=Injector.define}(window);