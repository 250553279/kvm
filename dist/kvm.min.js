/**
 ** kvm.js - 一款兼容AMD,angular模块规范同时支持依赖注入的模块管理器
 ** @author Janry
 ** @version v0.0.3
 **/
!function(global){function _type(n){return Object.prototype.toString.call(n)}function isReference(n){return isArray(n)||isObject(n)}function isValue(n){return!isReference(n)}function isEmpty(n){if(null==n)return!0;if(n.length>0)return!1;if(0===n.length)return!0;for(var t in n)if(hasOwnProperty.call(n,t))return!1;return!0}function toArray(){var n;return n=[].slice.apply(arguments),[].slice.apply(n[0],n.slice(1))}function getKeyLength(n){return isArray(n)?n.length:isObject(n)?Object.keys(n).length:0}function unique(n){for(var t=0;t<n.length;++t)for(var e=t+1;e<n.length;++e)n[t]===n[e]&&n.splice(e--,1);return n}function bind(n,t){return function(){return isFunction(n)?n.apply(t,toArray(arguments)):void 0}}function forEach(n,t,e){var r,i,o,s;if(isFunction(t)){if(isReference(n)){for(i=Object.keys(n),o=i.length,r=0,s=[],0==o&&isFunction(e)&&e();o>r&&t(n[i[r]],i[r])!==!1;)s.push(r++);return s}isFunction(e)&&e()}}function guid(){function n(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()}function eachTask(){var n,t,e,r=toArray(arguments),i=[];isArray(r[0])&&(n=r[0],2==r.length&&(e=r[1]),r.length>2&&(t=r[1],e=r[2]),function o(n,r){var s,c,u=n.length;u>r&&(s=function(){i=toArray(arguments),u>r+1?o(n,r+1):e.apply(null,i)},c=function(){i=toArray(arguments),isFunction(t)?(i.unshift(s),t.apply(null,i)):u>r+1?o(n,r+1):e.apply(null,i)},isFunction(n[r])?(i.unshift(c),n[r].apply(null,i)):isFunction(t)&&(i=[n[r],s],t.apply(null,i)))}(n,0))}function crawlObject(n,t,e){e=isBoolean(e)&&e===!1?!1:!0,isFunction(t)&&forEach(n,function(n,r){isReference(n)&&e?(t(n,r),crawlObject(n,t)):t(n,r)})}function merge(){var n,t,e,r=!1,i=!0;return n=toArray(arguments),isBoolean(n[0])&&(r=n[0],n=n.slice(1)),isFunction(n[n.length-1])&&(e=n[n.length-1],n.pop()),isBoolean(n[n.length-1])&&(i=n[n.length-1],n.pop()),t=n.length,2>t?n[0]:2===t?(forEach(n[1],function(t,o){isFunction(e)&&e(o,n[0],n[1]),void 0!==n[1][o]&&null!==n[1][o]&&(i?(n[0][o]=n[0][o]||n[1][o].constructor(),r&&isReference(t)?merge(r,n[0][o],t,i,e):n[0][o]=t):n[0][o]||(n[0][o]=n[0][o]||n[1][o].constructor(),r&&isReference(t)?merge(r,n[0][o],t,i,e):n[0][o]=t))}),n[0]):merge(r,n[0],merge.apply(null,[r].concat(n.slice(1))))}function copy(){var n,t,e,r,i,o;return n=toArray(arguments),e=!1,isBoolean(n[0])&&(e=n[0]===!0?!0:!1,n=n.slice(1)),isValue(n[0])?n[0]:(t=n[1]&&isFunction(n[1])?n[1]:!1,i=n[2]&&isString(n[2])?n[2]:"",r=isArray(n[0])?1:2,o=n[0].constructor(),forEach(n[0],function(n,s){var c,u;u=i?2===r?i+"."+s:i+"["+s+"]":s,t?(c=t(n,s,u),isBoolean(c)?c&&e&&isReference(n)?(o[s]=copy(e,n,t,u),u=i):o[s]=n:e&&isReference(n)?(o[s]=copy(e,n,t,u),u=i):o[s]=n):e&&isReference(n)?(o[s]=copy(e,n,t,u),u=i):o[s]=n}),o)}function Do(n,t){this.data=n,this._commands.__parent__=this,this._filters.__parent__=this,t&&this.exec(t)}function Class(n,t){return n&&n.constructor&&isFunction(n.constructor)&&n.constructor!==Object?(_class=function(){return n.constructor.apply(this,toArray(arguments))},_class.toString=function(){return n.constructor.toString()}):_class=function(){},merge(_class.prototype,n),merge(_class,t),_class}for(var TYPES="Function,String,Array,Object,Number,Boolean".split(","),hasOwnProperty=Object.prototype.hasOwnProperty,i=0;i<TYPES.length;i++)eval("function is"+TYPES[i]+'(val){return _type(val) === "[object '+TYPES[i]+']"};');var COMMANDS={OPERATORS:"$remove,$set,$push,$slice,$concat,$pop,$unshift,$merge,$deep_merge,$clone,$find,$sort,$foreach".split(","),FILTERS:"$gt,$lt,$is,$not,$gte,$lte,$icontains,$contains,$in,$not_in,$and,$or".split(","),SORTS:"$desc,$asc".split(","),CLONES:"$white_list,$black_list,$filter,$deep".split(","),COMMONS:"$callback".split(",")},KEYWORDS=function(){var n,t,e,r,i,o;e={};for(t in COMMANDS)for(o=COMMANDS[t],r=0,i=o.length;i>r;r++)n=o[r],e[n]=!0;return e}();merge(Do.prototype,{_collect:function(n){var t,e;if(e={operators:{},filters:{},sorts:{},clones:{},commons:{},props:{},value:null},!isReference(n))return e.value=n,e;for(t in n)COMMANDS.OPERATORS.indexOf(t)>-1?e.operators[t]=n[t]:COMMANDS.FILTERS.indexOf(t)>-1?e.filters[t]=n[t]:COMMANDS.SORTS.indexOf(t)>-1?e.sorts[t]=n[t]:COMMANDS.CLONES.indexOf(t)>-1?e.clones[t]=n[t]:COMMANDS.COMMONS.indexOf(t)>-1?e.commons[t]=n[t]:e.props[t]=n[t];return e},_filters:{$is:function(n,t){return n===t},$not:function(n,t){return n!==t},$gt:function(n,t){return n>t},$lt:function(n,t){return t>n},$gte:function(n,t){return n>=t},$lte:function(n,t){return t>=n},$icontains:function(n,t){return n.toLowerCase().indexOf(t.toLowerCase())>-1},$contains:function(n,t){return n.indexOf(t)>-1},$in:function(n,t){return t.indexOf(n)>-1},$not_in:function(n,t){return-1===t.indexOf(n)}},_commands:{$set:function(n,t){var e,r,i,o;i=t.props,o=[];for(e in i)r=i[e],isReference(r)?(n[e]=n[e]||r.constructor(),o.push(this.$set(n[e],this.__parent__._collect(r)))):o.push(n[e]=r);return o},$remove:function(n,t){var e,r,i,o;i=t.props,o=[];for(e in i)r=i[e],o.push(isArray(n)||r!==!0?void 0:delete n[e]);return o},$slice:function(n,t){var e,r,i,o;i=t.props,o=[];for(e in i)r=i[e],n[e]&&isArray(n[e])?(isArray(r)||(r=[r]),o.push(n[e]=n[e].slice.apply(n[e],r))):o.push(void 0);return o},$push:function(n,t){var e,r,i,o;i=t.props,o=[];for(e in i)r=i[e],o.push(n[e]&&isArray(n[e])?n[e].push(r):void 0);return o},$concat:function(n,t){var e,r,i,o;i=t.props,o=[];for(e in i)r=i[e],n[e]&&isArray(n[e])?(isArray(r)||(r=[r]),o.push(n[e]=n[e].concat(r))):o.push(void 0);return o},$pop:function(n,t){var e,r,i,o;i=t.props,o=[];for(e in i)r=i[e],o.push(n[e]&&isArray(n[e])?n[e].pop():void 0);return o},$unshift:function(n,t){var e,r,i,o;i=t.props,o=[];for(e in i)r=i[e],o.push(n[e]&&isArray(n[e])?n[e].unshift(r):void 0);return o},$merge:function(n,t){return merge(n,t.props)},$deep_merge:function(n,t){return merge(!0,n,t.props)},$clone:function(n,t){var e,r,i,o,s,c;return o=!!t.clones.$deep,c=t.clones.$white_list,e=t.clones.$black_list,i=t.clones.$filter,r=t.commons.$callback,s=isEmpty(c)?isEmpty(e)?isFunction(i)?copy(o,n,function(n,t,e){var r;return isFunction(i)&&(r=i(n,t,e)),isBoolean(r)?r?!0:!1:!0}):copy(o,n):copy(o,n,function(n,t,r){var o;return inPaths(r,e)?!1:(isFunction(i)&&(o=i(n,t,r)),isBoolean(o)?o?!0:!1:!0)}):copy(o,n,function(n,t,r){var o;return inPaths(r,c,!0)?isEmpty(e)?!0:inPaths(r,e)?!1:(isFunction(i)&&(o=i(n,t,r)),isBoolean(o)?o?!0:!1:!0):!1}),isFunction(r)?r(s):void 0},$find:function(n,t){function e(n,t){var e=!0;return n==t?e:(void 0==n||null==n?t&&(e=!t):e=n,e)}var r,i,o,s;return s=this,r=t.commons.$callback,i=Object.keys(t.filters).length,o=[],isEmpty(t.filters)?o=n:forEach(n,function(n){var r=0,c=e(t.filters.$and,t.filters.$or);isEmpty(n)||(forEach(t.filters,function(t,i){if("$or"==i||"$and"==i)return!0;var o=0,c=e(t.$and,t.$or);forEach(t,function(t,e){return"$or"==e||"$and"==e?!0:s.__parent__._filters[i](n[e],t)?c?o++:(o++,!1):void 0}),c?o>=getKeyLength(t)&&r++:o>0&&r++}),c?r>0&&o.push(n):r>=i&&o.push(n))}),isFunction(r)?r(o):void 0},$foreach:function(n,t){return isFunction(t.value)?forEach(n,t.value):void 0},$sort:function(n,t){var e,r,i,o;if(isArray(n)&&isReference(t.value)){i=t.props,o=[];for(e in i)r=i[e],o.push("desc"===r?n.sort(function(n,t){return isReference(n)&&isReference(t)?n[e]<t[e]?1:-1:t>n?1:-1}):n.sort(function(n,t){return isReference(n)&&isReference(t)?n[e]>t[e]?1:-1:n>t?1:-1}));return o}return n.sort("desc"===t.value?function(n,t){return t-n}:function(n,t){return n-t})}},_exec:function(n,t){var e,r,i;i=[];for(r in t)e=t[r],this._commands[r]?i.push(this._commands[r](n,this._collect(e))):isReference(e)&&!KEYWORDS[r]?(n[r]=n[r]||e.constructor(),i.push(this._exec(n[r],e))):i.push(void 0);return i},exec:function(n){return this._exec(this.data,n)}}),Do.exec=function(n,t,e){return isFunction(e)&&crawlObject(t,function(n,t){var r;("$find"==t||"$clone"==t)&&(r=n.$callback||function(){},n.$callback=function(){var n=toArray(arguments);e.apply(null,n),r.apply(null,n)})}),new Do(n,t)},Class.inherit=function(){function n(n,t){function e(){return n.apply(this,t)}return e.prototype=n.prototype,new e}function t(){var e=n(i,toArray(arguments));return merge(this,e,!1),this.$super=t,this.$parent&&isArray(this.$parent)?this.$parent.push(e):this.$parent=[e],e}var e=toArray(arguments);if(2==e.length){var r=e[0],i=e[1];isFunction(r)&&isFunction(i)&&(merge(r.prototype,i.prototype,!1,function(n,t,e){if(e.$$isprotocol===!0&&isFunction(e[n])&&!isFunction(t[n]))throw"The subclass does not follow protocol"}),r.prototype.$super=t,r.prototype.$parent=i.prototype,r.prototype.constructor=r)}else if(e.length>2)for(var o=1;o<e.length;o++)Class.inherit(e[0],e[o])},Class.protocol=function(n){return n.$$isprotocol=!0,Class(n)};var Emitter=Class({constructor:function(n){this.__$$events__=n?n:{}},$on:function(n,t){var e=this;return n=n.split(","),forEach(n,function(n){isFunction(t)&&(e.__$$events__[n]&&isArray(e.__$$events__[n])?e.__$$events__[n].push(t):e.__$$events__[n]=[t])}),this},$emit:function(n){var t=toArray(arguments),e=0,r=this.__$$events__[n];if(r&&isArray(r))for(e;e<r.length;e++)r[e].apply(null,t.slice(1));return this},$remove:function(n,t){var e=this.__$$events__[n];if(e&&isArray(e))if(t)for(var r=e.length-1;r>=0;r--)t===e[r]&&e.splice(r,1);else delete this.__$$events__[n];return this}}),Loader=function(){var n=[],t=Class({constructor:function(t,r){var i=this,o=Injector.data("shims");i.req_list=t,i.loaders=[],i.results=[],forEach(t,function(t){var s,c,u=Injector.resolve(t);if(forEach(n,function(n){return n.uri==u?(s=n,!1):void 0}),s||(s=new e(t,u,function(){o[t]&&Injector.define(t,o[t].factory)}),n.push(s)),s.module){if(i.results.push(s.module),i._checkDone())return r(i.results),!1}else if(c=ModuleDB.get(t,u)){if(i.results.push(c),i._checkDone())return r(i.results),!1}else i.loaders.push(s),s.$on("loaded",function(n){return s.module=n,i.results.push(n),i._checkDone()?(r(i.results),!1):void 0})}),forEach(i.loaders,function(n){n.load()})},_checkDone:function(){return this.req_list.length==this.results.length}}),e=Class({constructor:function(n,t,e){var r=this;this.id=n,this.uri=t,this.callback=e,this.state="pendding",this.module=null,this.$super(),this.$on("loaded",function(){r.state="done"})},load:function(){this._load(this.uri,this.callback)},_load:function(n,t){function e(n,t){function e(e){n.onload=n.onerror=n.onreadystatechange=null,Injector.debug||i.removeChild(n),n=null,t&&t(e)}var r="onload"in n;r?(n.onload=e,n.onerror=function(){e(!0)}):n.onreadystatechange=function(){/loaded|complete/.test(n.readyState)&&e()}}var r=document,i=r.head||r.getElementsByTagName("head")[0]||r.documentElement,o=i.getElementsByTagName("base")[0],s=r.createElement("script");s.async=!0,s.src=n,e(s,t),o?i.insertBefore(s,o):i.appendChild(s)}});return Class.inherit(e,Emitter),Class({constructor:function(n){this.module=n},setModule:function(n){this.module=n},fetchDeps:function(n){var t=[],e=this;forEach(this.module.dep_ids,function(n){e.module.injectors&&e.module.injectors[n]||t.push(n)}),Loader.fetchList(t,n)},fetch:function(n){Loader.fetchList([this.module.id],function(t){t&&t.length>0&&isFunction(n)&&n(t[0])})}},{getLoader:function(t,e,r){var e=e||Injector.resolve(t);if(!e)throw new Error("资源未标识");forEach(n,function(n){return n.uri&&n.uri==e||n.id&&n.id==t?(r(n),!1):void 0})},fetchList:function(){var n=[],e=toArray(arguments),r=e[e.length-1];isFunction(r)&&(e=e.slice(0,e.length-1),forEach(e,function(t){isArray(t)?n=n.concat(t):n.push(t)}),new t(n,r))}})}(),Module=Class({constructor:function(n){merge(this,{id:"",uri:"",dep_ids:[],factory:null,injectors:null},n),this.$super(),this.register()},register:function(){var n=this;this.$on("loaded",function(){n.loaded=!0}),this.$on("invoked",function(){n.invoked=!0})}}),ModuleDB=function(){var n=[];return Class.inherit(Module,Emitter),{add:function(t){var e=new Module(t);return this.get(t.id,t.uri)||(n.push(e),e.$emit("loaded"),Loader.getLoader(t.id,t.uri,function(n){n.$emit("loaded",e)})),this},get:function(t,e){var r;return forEach(n,function(n){return n.id&&t&&n.id==t||n.uri&&e&&n.uri==e?(r=n,!1):void 0}),r}}}(),Injector=function(){function n(){var n=document,t=n.head||n.getElementsByTagName("head")[0]||n.documentElement;if(n.currentScript)return n.currentScript.src;var e;try{a.b.c()}catch(r){e=r.stack,!e&&window.opera&&(e=(String(r).match(/of linked script \S+/g)||[]).join(" "))}if(e)return e=e.split(/[@ ]/g).pop(),e="("==e[0]?e.slice(1,-1):e,e.replace(/(:\d+)?:\d+$/i,"");for(var i,o=t.getElementsByTagName("script"),s=0;i=o[s++];)if("interactive"===i.readyState)return i.className=i.src}function t(n,t){return e(t)?t:r(t)?i(n,t)+".js":t}function e(n){return/^https?:|^file:|^\/|\.js$/.test(n)}function r(n){return 0===(n+"").indexOf(".")}function i(){var n=arguments.length;if(0===n)throw new Error("resolveUrl requires at least one argument; got none.");var t=document.createElement("base");if(t.href=arguments[0],1===n)return t.href;var e=document.getElementsByTagName("head")[0];e.insertBefore(t,e.firstChild);for(var r,i=document.createElement("a"),o=1;n>o;o++)i.href=arguments[o],r=i.href,t.href=r;return e.removeChild(t),r}function o(n){return isFunction(n)||isArray(n)&&isFunction(n[n.length-1])}function s(n){var t=!0;return isArray(n)?(forEach(n,function(n){return isString(n)?void 0:t=!1}),t):!1}function c(){var t,e=toArray(arguments),r="",i="",c=[],u=null,a=!0;return isBoolean(e[0])?(a=e[0],e=e.slice(1,4)):e=e.slice(0,3),forEach(e,function(n){o(n)?isFunction(n)?t=n:(t=n[n.length-1],c=n.slice(0,n.length-1)):s(n)?c=n:isString(n)?(r=n,i=Injector.resolve(r)):isObject(n)&&(u=n)}),!i&&a&&(i=n()),new Module({uri:i,id:r,dep_ids:c,factory:t,injectors:u})}function u(n,t,e,r){function i(e,i){var c;i&&(o[e]=i,s++),s==t.dep_ids.length&&(c=r?t.instance?t.instance:t.instance=t.factory.apply(null,o):t.factory.apply(null,o),t.$emit("invoked"),n(c))}var o=[],s=0;r=isBoolean(r)?r:!1,forEach(t.dep_ids,function(n,o){t.injectors&&t.injectors[n]?Injector.invoke(t.injectors[n]).then(function(n){i(o,n)})["catch"](function(n){throw n}):forEach(e,function(t){(t.id&&t.id==n||t.uri&&t.uri==Injector.resolve(n))&&(t.instance&&r&&i(o,t.instance),Injector.invoke(n).then(function(n){i(o,n)})["catch"](function(n){throw n}))})},function(){i()})}function l(n){if(!isString(n))throw new Error("路径类型错误");var t,e=/\{([^{}]+)\}/g;return t=n.replace(e,function(n,t){return f.vars[t]?f.vars[t]:t}),e.test(t)?tmp(t):t}var f={baseUrl:window.location.href,shims:{},vars:{},alias:{}};return{config:function(n){merge(f,n)},resolve:function(n){return n=l(f.shims[n]?f.shims[n].url||f.shims[n].uri:f.alias[n]?f.alias[n]:n),t(f.baseUrl,n)},data:function(n){return n?f[n]:f},define:function(){var n=c.apply(null,toArray(arguments));if(!n.uri||!n.factory)throw new Error("模块定义不规范");ModuleDB.add(n)},invoke:function(){var n,t,e=toArray(arguments);return e.unshift(!1),n=c.apply(null,e),t=new Loader(n),new Promise(function(e){if(n.id&&!n.factory)t.fetch(function(r){r=merge(n,r),t.setModule(r),r.dep_ids.length>0?t.fetchDeps(function(n){u(e,r,n,!0)}):u(e,r,[])});else{if(n.id||!n.factory)throw new Error("模块调用不符合规范");n.dep_ids.length>0?t.fetchDeps(function(t){u(e,n,t)}):u(e,n,[])}})},use:function(n,t){this.invoke(n).then(t)["catch"](function(n){throw n})}}}();Injector.define("$do",function(){return Do}),Injector.define("$dataOperator",function(){return Do}),Injector.define("$class",function(){return Class}),Injector.define("$emitter",function(){return Emitter}),global.kvm={},merge(global.kvm,{isArray:isArray,isString:isString,isFunction:isFunction,isObject:isObject,isReference:isReference,isEmpty:isEmpty,isBoolean:isBoolean,getKeyLength:getKeyLength,isValue:isValue,guid:guid,unique:unique,toArray:toArray,bind:bind,forEach:forEach,merge:merge,eachTask:eachTask,copy:copy}),global.KVM=global.kvm,global.kvm.module=Injector,global.KVM.Module=Injector,global.define=Injector.define}(window);